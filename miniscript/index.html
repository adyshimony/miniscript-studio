<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Miniscript Studio</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🔨</text></svg>">
    <style>
        /* Dark theme (default) */
        :root {
            --bg-gradient: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            --container-bg: #2d3748;
            --text-color: #e2e8f0;
            --text-secondary: #cbd5e0;
            --text-muted: #a0aec0;
            --border-color: #4a5568;
            --border-focus: #63b3ed;
            --button-secondary-bg: #4a5568;
            --button-secondary-hover: #718096;
            --info-bg: #2d3748;
            --success-bg: #22543d;
            --success-border: #38a169;
            --error-bg: #742a2a;
            --error-border: #e53e3e;
            --error-text: #feb2b2;
            --accent-color: #63b3ed;
            --hover-bg: #374151;
            --warning-bg: #44337a;
            --warning-border: #9f7aea;
            --secondary-text: #cbd5e0;
            --modal-bg: #1f2937;
            --code-bg: #1a202c;
            --ribbon-bg: transparent;
        }
        
        /* Light theme */
        [data-theme="light"] {
            --bg-gradient: linear-gradient(135deg, #f7fafc 0%, #e2e8f0 100%);
            --container-bg: #ffffff;
            --text-color: #2d3748;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --border-color: #e2e8f0;
            --border-focus: #4299e1;
            --button-secondary-bg: #e2e8f0;
            --button-secondary-hover: #cbd5e0;
            --info-bg: #f7fafc;
            --success-bg: #c6f6d5;
            --success-border: #48bb78;
            --error-bg: #fed7d7;
            --error-border: #f56565;
            --error-text: #c53030;
            --accent-color: #3182ce;
            --hover-bg: #f7fafc;
            --warning-bg: #e9d8fd;
            --warning-border: #b794f4;
            --secondary-text: #4a5568;
            --input-bg: #e2e8f0;
            --modal-bg: #ffffff;
            --code-bg: #f7fafc;
            --ribbon-bg: transparent;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            margin: 0;
            padding: 0;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-color);
            box-sizing: border-box;
        }

        * {
            font-family: inherit;
        }

        .main-content {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .container {
            background: var(--container-bg);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            position: relative;
        }
        
        h1 {
            text-align: center;
            color: var(--text-secondary);
            margin-top: 50px;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .input-section {
            margin-bottom: 30px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        #policy-input, #expression-input {
            width: 100%;
            height: 100px;
            padding: 10px 15px;
            border: 2px solid var(--border-color) !important;
            border-radius: 8px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s ease;
            background: var(--container-bg);
            color: var(--text-color);
            box-sizing: border-box;
            outline: none;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .textarea-like {
            width: 100%;
            min-height: 60px;
            padding: 10px;
            border: 2px solid var(--border-color) !important;
            border-radius: 4px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            background: var(--container-bg);
            color: var(--text-color);
            box-sizing: border-box;
            outline: none;
        }
        
        /* Match placeholder style to miniscript editor */
        .textarea-like::placeholder {
            color: var(--text-muted);
            opacity: 1;
            font-size: 14px;
        }

        /* Make editable inputs brighter to show they're editable */
        #policy-input,
        #expression-input,
        #key-name-input,
        #key-value-input,
        #script-hex-display,
        #script-asm-display {
            filter: brightness(1.3);
        }
        
        [data-theme="light"] #policy-input,
        [data-theme="light"] #expression-input {
            filter: brightness(1) !important;
            background: var(--input-bg) !important;
            border: 2px solid var(--border-color) !important;
        }
        
        [data-theme="light"] #key-name-input,
        [data-theme="light"] #key-value-input {
            filter: brightness(1) !important;
            background: var(--input-bg) !important;
            border: 2px solid var(--border-color) !important;
        }
        
        [data-theme="light"] #script-hex-display,
        [data-theme="light"] #script-asm-display {
            filter: brightness(1) !important;
            background: var(--input-bg) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        /* Force borders to remain visible after JavaScript innerHTML updates */
        [data-theme="light"] #policy-input[contenteditable],
        [data-theme="light"] #expression-input[contenteditable] {
            border: 2px solid var(--border-color) !important;
            background: var(--input-bg) !important;
        }
        
        #policy-input:focus, #expression-input:focus {
            outline: none !important;
            border: 2px solid var(--border-focus) !important;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        /* Policy editor specific styles */
        .policy-editor {
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.4;
            min-height: 140px;
        }
        
        .policy-editor:empty::before {
            content: attr(data-placeholder);
            color: var(--text-muted);
            pointer-events: none;
            white-space: pre-line;
        }
        
        /* Syntax highlighting colors */
        .syntax-function {
            color: #3b82f6;
            font-weight: 600;
        }
        
        .syntax-operator {
            color: #8b5cf6;
            font-weight: 600;
        }
        
        .syntax-key {
            color: #10b981;
            font-weight: 500;
        }
        
        .syntax-number {
            color: #f59e0b;
            font-weight: 500;
        }
        
        .syntax-parenthesis {
            color: var(--text-color);
            font-weight: bold;
        }
        
        .syntax-comma {
            color: var(--text-secondary);
        }
        
        /* Miniscript editor specific styles */
        .miniscript-editor {
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.4;
            min-height: 140px;
        }
        
        .miniscript-editor:empty::before {
            content: attr(data-placeholder);
            color: var(--text-muted);
            pointer-events: none;
            white-space: pre-line;
        }
        
        /* Miniscript-specific syntax highlighting colors */
        .syntax-fragment {
            color: #3b82f6;
            font-weight: 600;
        }
        
        .syntax-wrapper {
            color: #f59e0b;
            font-weight: 600;
        }
        
        .syntax-threshold {
            color: #8b5cf6;
            font-weight: 600;
        }
        
        .syntax-multisig {
            color: #ef4444;
            font-weight: 600;
        }
        
        .syntax-hash-fragment {
            color: #06b6d4;
            font-weight: 500;
        }
        
        /* HD wallet descriptor syntax highlighting */
        .syntax-descriptor-bracket {
            color: #64748b;
            font-weight: 600;
            display: inline;
            white-space: normal;
        }

        .syntax-fingerprint {
            color: #dc2626;
            font-weight: 500;
            font-family: 'Consolas', 'Courier New', monospace;
            display: inline;
            white-space: normal;
        }

        .syntax-derivation-path {
            color: #059669;
            font-weight: 500;
            display: inline;
            white-space: normal;
        }

        .syntax-xpub {
            color: #7c3aed;
            font-weight: 500;
            font-family: 'Consolas', 'Courier New', monospace;
            display: inline;
            white-space: normal;
            word-break: break-all;
        }

        .syntax-range {
            color: #ea580c;
            font-weight: 600;
            display: inline;
            white-space: normal;
        }
        
        .syntax-wildcard {
            color: #0891b2;
            font-weight: 600;
        }
        
        .syntax-pubkey {
            color: #be123c;
            font-weight: 500;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 0.95em;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            min-width: 0;
        }

        .button-group button {
            flex-shrink: 1;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .examples-section .button-group {
            align-items: flex-start;
        }

        .examples-section .button-group button {
            font-size: 11px !important;
            padding: 4px 8px !important;
            min-width: 60px;
        }
        
        code {
            overflow-wrap: break-word;
            word-break: break-all;
            white-space: normal;
            font-size: inherit;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .primary-btn {
            background: #4a5568;
            color: #e2e8f0;
        }
        
        .primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(61, 69, 83, 0.3);
            background: #4a5568;
        }
        
        .secondary-btn {
            background: #4a5568;
            color: #e2e8f0;
        }
        
        .secondary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(61, 69, 83, 0.3);
            background: #4a5568;
        }
        
        /* Light theme button overrides */
        [data-theme="light"] .primary-btn {
            background: #cbd5e0;
            color: #475569;
        }
        
        [data-theme="light"] .primary-btn:hover {
            background: #a0aec0;
            box-shadow: 0 5px 15px rgba(160, 174, 192, 0.4);
        }
        
        [data-theme="light"] .secondary-btn {
            background: #cbd5e0;
            color: #475569;
        }
        
        [data-theme="light"] .secondary-btn:hover {
            background: #a0aec0;
            box-shadow: 0 5px 15px rgba(160, 174, 192, 0.4);
        }
        
        .danger-btn {
            background: #e53e3e;
            color: white;
        }
        
        .danger-btn:hover {
            background: #c53030;
        }
        
        .saved-expressions {
            margin-bottom: 20px;
        }
        
        .expression-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--info-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 8px;
            min-width: 0;
        }

        .expression-info {
            flex: 1;
            min-width: 0;
            margin-right: 10px;
        }
        
        .expression-name {
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        .expression-preview {
            font-family: 'Consolas', 'Courier New', monospace;
            color: var(--text-muted);
            font-size: 10px;
            word-break: break-all;
            line-height: 1.2;
        }
        
        .results-section {
            margin-top: 30px;
        }
        
        .result-box {
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-family: 'Consolas', 'Courier New', monospace;
        }
        
        .error {
            background: var(--error-bg);
            border: 1px solid var(--error-border);
            color: var(--error-text);
            word-wrap: break-word;
            overflow-wrap: break-word;
            font-size: 13px;
            white-space: pre-wrap;
        }
        
        .success {
            background: var(--success-bg);
            border: 1px solid var(--success-border);
            color: var(--text-color);
            font-size: 13px;
        }

        .success h4 {
            font-size: 13px;
            font-weight: bold;
            margin: 0;
        }
        
        .info {
            background: var(--info-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            font-size: 13px;
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--container-bg);
            padding: 30px;
            border-radius: 12px;
            min-width: 300px;
            color: var(--text-color);
        }
        
        #save-name {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: var(--container-bg);
            color: var(--text-color);
            box-sizing: border-box;
        }

        .key-variable-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--container-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 8px;
            min-width: 0;
        }

        .key-info {
            flex: 1;
            min-width: 0;
            margin-right: 10px;
        }

        .key-name {
            font-weight: 600;
            color: var(--text-secondary);
            font-family: 'Consolas', 'Courier New', monospace;
        }

        .key-value {
            font-family: 'Consolas', 'Courier New', monospace;
            color: var(--text-muted);
            font-size: 10px;
            word-break: break-all;
            line-height: 1.2;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .key-value.xonly {
            color: #8b5cf6;
        }

        .key-value.compressed {
            color: #3b82f6;
        }

        .key-badge {
            font-size: 8px;
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .key-badge.xonly {
            background: #8b5cf6;
            color: white;
        }

        .key-badge.compressed {
            background: #3b82f6;
            color: white;
        }

        .key-badge.xpub {
            background: #10b981;
            color: white;
        }

        .key-badge.tpub {
            background: #f59e0b;
            color: white;
        }

        .add-key-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .add-key-form input {
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: var(--container-bg);
            color: var(--text-color);
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .add-key-form input:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 10px;
                max-width: 100%;
            }

            .container {
                padding: 15px;
                margin-bottom: 15px;
            }

            h1 {
                font-size: 1.8em;
                margin-top: 20px;
                margin-bottom: 20px;
            }
            
            /* Mobile: Compile/Save/Load/Clear buttons in horizontal line */
            #compile-policy-btn, #save-policy-btn, #load-policy-btn, #clear-policy-btn,
            #compile-btn, #save-btn, #load-btn, #clear-btn {
                font-size: 13px !important;
                padding: 10px 12px !important;
            }
            
            /* Mobile: Hide auto-compile containers and theme toggle */
            .auto-compile-container {
                display: none !important;
            }

            /* Mobile: Hide derivation index on mobile for space */
            #derivation-index-container {
                display: none !important;
            }
            
            /* Mobile: Hide floating theme toggle (available in settings) */
            #floating-theme-toggle {
                display: none !important;
            }
            
            /* Mobile: Always hide corner buttons regardless of setting */
            a[href*="coinos.io"], a[href*="github.com"] {
                display: none !important;
            }
            
            /* Mobile: Force button containers to take full width */
            div[style*="display: flex"][style*="justify-content: space-between"] .button-group {
                width: 100% !important;
                flex: 1 !important;
                display: flex !important;
                flex-direction: row !important;
                gap: 6px !important;
            }

            div[style*="display: flex"][style*="justify-content: space-between"] .button-group button {
                font-size: 12px !important;
                padding: 12px 8px !important;
                min-width: 0 !important;
                flex: 1 !important;
                white-space: nowrap !important;
            }

            /* Mobile: Reorganize layout - move description panels above examples, full width */
            div[style*="display: flex"][style*="gap: 20px"][style*="align-items: flex-start"] {
                flex-direction: column !important;
                gap: 15px !important;
            }
            
            /* Mobile: Description panels full width and repositioned */
            .policy-description-panel,
            .miniscript-description-panel {
                flex: none !important;
                width: calc(100% - 32px) !important; /* Account for container padding */
                max-width: 100% !important;
                min-width: 0 !important;
                order: -1 !important; /* Move above examples */
                margin-bottom: 10px;
                box-sizing: border-box !important;
                overflow: hidden !important;
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
            }

            /* Mobile: Example buttons in grid */
            .examples-section .button-group {
                display: grid !important;
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
                flex-direction: unset !important;
            }

            .examples-section .button-group button {
                font-size: 10px !important;
                padding: 6px 8px !important;
                width: 100%;
                flex: unset !important;
            }

            /* Mobile: Consistent text area styling */
            #policy-input, #expression-input {
                font-size: 16px;
                padding: 12px 15px;
            }
            
            /* Mobile: Fix settings items layout to prevent overflow */
            .setting-item {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 10px !important;
            }
            
            .setting-item > div:first-child {
                width: 100% !important;
            }
            
            .setting-item > label,
            .setting-item > select {
                align-self: flex-end !important;
                flex-shrink: 0 !important;
            }

            .add-key-form input {
                font-size: 16px;
                padding: 12px;
                height: auto;
            }

            .key-variable-item, .expression-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                padding: 12px;
            }

            .key-info, .expression-info {
                margin-right: 0;
                margin-bottom: 8px;
            }

            .radio-group {
                flex-direction: column;
                gap: 12px !important;
            }

            .radio-group label {
                font-size: 16px;
            }

            details summary {
                font-size: 16px;
                padding: 8px 0;
            }

            .result-box {
                padding: 15px;
                margin-bottom: 10px;
            }

            .result-box h4 {
                font-size: 16px;
            }

            textarea[readonly] {
                font-size: 12px !important;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 8px;
            }

            .container {
                padding: 12px;
            }

            h1 {
                font-size: 1.5em;
            }

            .examples-section .button-group button {
                font-size: 9px !important;
                padding: 4px 6px !important;
                min-width: 45px;
            }

            details > div {
                padding: 15px !important;
            }

            .modal-content {
                margin: 20px;
                min-width: auto;
                width: calc(100% - 40px);
            }
        }

        /* Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px !important;
            height: 24px !important;
            cursor: pointer;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color);
            border-radius: 12px;
            transition: 0.2s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: 0.2s;
        }

        input:checked + .toggle-slider {
            background-color: var(--border-focus);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        /* Fix word-breaking in tip descriptions and settings descriptions */
        .tip-item p, .setting-item p {
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
            word-break: normal !important;
        }

        /* Debug info display styling */
        .debug-info-container {
            margin: 15px 0;
        }

        .basic-debug-section {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .basic-debug-section:last-child {
            border-bottom: none;
        }

        .basic-debug-section h5 {
            color: var(--text-color);
            font-size: 13px;
            font-weight: 600;
            margin: 0 0 12px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .property-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
        }

        .property-item {
            background: var(--code-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 6px 10px;
            font-size: 12px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        .property-item.true {
            background: var(--success-bg);
            border-color: var(--success-border);
            color: var(--text-color);
        }

        .property-item.false {
            background: var(--error-bg);
            border-color: var(--error-border);
            color: var(--error-text);
        }

        .miniscript-expression-section {
            background: var(--code-bg);
            border-radius: 4px;
            margin: 0;
        }

        .expression-display {
            background: transparent;
            border: none;
            color: inherit;
            font-family: inherit;
            font-size: inherit;
            line-height: inherit;
            padding: 12px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
        }

        .debug-console-notice {
            background: var(--info-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px 12px;
            font-size: 12px;
            color: var(--text-secondary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .debug-console-notice strong {
            color: var(--text-color);
        }

        /* Simple debug text display */
        .debug-text-display {
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 12px;
            margin: 0;
            max-height: 600px;
            overflow-y: auto;
            overflow-x: auto;
        }

        .debug-text-display pre {
            margin: 0;
            font-family: inherit;
            font-size: inherit;
            line-height: inherit;
            color: inherit;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <!-- Beer button -->
    <a href="https://coinos.io/adys/receive" target="_blank" style="position: fixed; top: 10px; left: 10px; z-index: 1000; font-size: 16px; text-decoration: none; transform: rotate(-45deg);" title="Buy me a beer 🍺">🍺</a>
    
    <!-- GitHub button -->
    <a href="https://github.com/adyshimony/miniscript-studio" target="_blank" style="position: fixed; top: 10px; right: 11px; z-index: 1000; font-size: 16px; text-decoration: none;" title="View source on GitHub">🐙</a>
    
    <style>
        .corner-ribbon-left, .corner-ribbon-right {
            position: fixed;
            top: 0;
            z-index: 1000;
            transition: opacity 0.2s;
        }
        .corner-ribbon-left {
            left: 0;
        }
        .corner-ribbon-right {
            right: 0;
        }
        .corner-svg {
            position: fixed;
            top: 0;
            z-index: 1000;
        }
        .corner-svg-left {
            left: 0;
        }
        .corner-svg-right {
            right: 0;
        }
        .corner-ribbon-left:hover, .corner-ribbon-right:hover {
            opacity: 0.8;
        }
        
        /* Mobile: hide corner ribbons and show bottom icons */
        @media (max-width: 768px) {
            .corner-ribbon-left, .corner-ribbon-right {
                display: none !important;
            }
            .mobile-icons {
                display: flex !important;
            }
            .mobile-icons a:hover {
                background: var(--hover-bg) !important;
                transform: translateY(-2px) !important;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
            }
            .main-content {
                padding-bottom: 0 !important;
            }
            .container {
                margin-bottom: 2px !important;
            }
            body, html {
                margin-bottom: 0 !important;
                padding-bottom: 0 !important;
            }
        }
        /* Theme toggle button styles */
        .theme-toggle {
            background: var(--container-bg);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 28px;
            height: 28px;
            min-width: 28px;
            min-height: 28px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            position: absolute;
            top: 20px;
            right: 30px;
            line-height: 1;
        }
        
        .theme-toggle:hover {
            /* Simple flat hover - no 3D effects */
        }
        
        @media (max-width: 768px) {
            .theme-toggle {
                width: 24px;
                height: 24px;
                min-width: 24px;
                min-height: 24px;
                font-size: 13px;
                top: 15px;
                right: 20px;
            }
        }

        /* Fix Windows dropdown styling in dark theme */
        select {
            background: var(--container-bg) !important;
            color: var(--text-color) !important;
            border: 1px solid var(--border-color) !important;
        }

        select option {
            background: var(--container-bg) !important;
            color: var(--text-color) !important;
        }

        /* Ensure dropdowns work properly on Windows */
        @media screen and (-ms-high-contrast: active), (-ms-high-contrast: none) {
            select {
                background: var(--container-bg) !important;
                color: var(--text-color) !important;
                border: 1px solid var(--border-color) !important;
            }

            select option {
                background: var(--container-bg) !important;
                color: var(--text-color) !important;
            }
        }
    </style>
    
    <div class="main-content">
        <div class="container">
            <!-- Theme toggle button -->
            <button id="floating-theme-toggle" class="theme-toggle" title="Toggle theme" aria-label="Toggle theme">
                <span id="theme-icon">☀️</span>
            </button>
            
            <h1>🔨 Miniscript Studio</h1>
        
        <div class="input-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <label for="policy-input">Policy (optional):</label>
                <div style="display: flex; align-items: center; gap: 0px;">
                    <button id="policy-key-names-toggle" onclick="togglePolicyKeyNames()" style="background: none; border: none; padding: 4px; margin: 0; cursor: pointer; font-size: 16px; color: var(--text-secondary); display: flex; align-items: center; border-radius: 3px;" title="Show key names" onmouseover="this.style.backgroundColor='var(--button-secondary-bg)'" onmouseout="this.style.backgroundColor='transparent'">
                        🏷️
                    </button>
                    <button id="extract-policy-keys-btn" style="background: none; border: none; padding: 4px; margin: 0; cursor: pointer; font-size: 16px; color: var(--text-secondary); display: flex; align-items: center; border-radius: 3px;" title="Extract keys from expression" onmouseover="this.style.backgroundColor='var(--button-secondary-bg)'" onmouseout="this.style.backgroundColor='transparent'">
                        🔑
                    </button>
                    <button id="policy-format-toggle" onclick="togglePolicyFormat()" style="background: none; border: none; padding: 4px; margin: 0; cursor: pointer; font-size: 16px; color: var(--text-secondary); display: flex; align-items: center; border-radius: 3px;" title="Toggle formatting" onmouseover="this.style.backgroundColor='var(--button-secondary-bg)'" onmouseout="this.style.backgroundColor='transparent'">
                        📐
                    </button>
                    <button onclick="removePolicyExtraChars()" style="background: none; border: none; padding: 4px; margin: 0; cursor: pointer; font-size: 16px; color: var(--text-secondary); display: flex; align-items: center; border-radius: 3px;" title="Remove extra characters" onmouseover="this.style.backgroundColor='var(--button-secondary-bg)'" onmouseout="this.style.backgroundColor='transparent'">
                        🧹
                    </button>
                    <button onclick="copyPolicyExpression()" style="background: none; border: none; padding: 4px; margin: 0; cursor: pointer; font-size: 16px; color: var(--text-secondary); display: flex; align-items: center; border-radius: 3px;" title="Copy policy expression" onmouseover="this.style.backgroundColor='var(--button-secondary-bg)'" onmouseout="this.style.backgroundColor='transparent'">
                        📋
                    </button>
                    <button onclick="sharePolicyExpression(event)" style="background: none; border: none; padding: 4px; margin: 0; cursor: pointer; font-size: 16px; color: var(--text-secondary); display: flex; align-items: center; border-radius: 3px;" title="Share policy via URL" onmouseover="this.style.backgroundColor='var(--button-secondary-bg)'" onmouseout="this.style.backgroundColor='transparent'">
                        🔗
                    </button>
                </div>
            </div>
            <div 
                id="policy-input" 
                contenteditable="true"
                spellcheck="false"
                class="policy-editor"
            ></div>
            
            <!-- Debug mode toggle for Policy tab -->

            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-top: 15px;">
                <div class="button-group">
                    <button id="compile-policy-btn" class="primary-btn">🔨 Compile</button>
                    <button id="save-policy-btn" class="secondary-btn">💾 Save</button>
                    <button id="load-policy-btn" class="secondary-btn">📂 Load</button>
                    <button id="clear-policy-btn" class="secondary-btn">🗑️ Clear</button>
                </div>
                <div class="auto-compile-container" style="display: flex; align-items: center; gap: 8px;">
                    <span style="color: var(--text-secondary); font-size: 14px;">Auto compile examples</span>
                    <label class="toggle-switch" title="Toggle auto-compilation when loading examples or saved expressions">
                        <input type="checkbox" id="auto-compile-policy">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            
            <!-- Policy error messages -->
            <div id="policy-errors" style="margin-top: 15px;"></div>
            
            <!-- Policy description panel aligned with examples -->
            <div style="display: flex; gap: 20px; align-items: flex-start; margin-top: 15px;">
                <div style="flex: 1;">
                    <h4 style="margin-bottom: 10px; color: var(--text-secondary); font-weight: 600; font-size: inherit;">Basic examples:</h4>
                    <div class="button-group" style="align-items: flex-start;" id="policy-buttons-start">
                        <button onclick="showPolicyDescription('single'); loadPolicyExample('pk(Alice)', 'single')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">Single key</button>
                        <button onclick="showPolicyDescription('or'); loadPolicyExample('or(pk(Alice),pk(Bob))', 'or')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">OR keys</button>
                        <button onclick="showPolicyDescription('and'); loadPolicyExample('and(pk(Alice),pk(Bob))', 'and')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">AND keys</button>
                        <button onclick="showPolicyDescription('threshold'); loadPolicyExample('thresh(2,pk(Alice),pk(Bob),pk(Charlie))', 'threshold')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">2-of-3 Threshold</button>
                        <button onclick="showPolicyDescription('alice_or_bob_timelock'); loadPolicyExample('or(pk(Alice),and(pk(Bob),older(144)))', 'alice_or_bob_timelock')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">Alice OR (Bob + 1 day)</button>
                        <button onclick="showPolicyDescription('testnet_xpub'); loadPolicyExample('pk(TestnetKey)', 'testnet_xpub')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">Testnet xpub</button>
                    </div>
                    <h4 style="margin: 20px 0 10px 0; color: var(--text-secondary); font-weight: 600; font-size: inherit;">Complex examples:</h4>
                    <div class="button-group" style="align-items: flex-start;">
                        <button onclick="showPolicyDescription('corporate'); loadPolicyExample('or(thresh(2,pk(Alice),pk(Bob),pk(Charlie)),and(pk(Eva),after(1767225600)))', 'corporate')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">Corporate Wallet</button>
                        <button onclick="showPolicyDescription('emergency_recovery'); loadPolicyExample('or(95@pk(Alice),and(thresh(2,pk(Bob),pk(Charlie),pk(Eva)),older(1008)))', 'emergency_recovery')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">Emergency Recovery</button>
                        <button onclick="showPolicyDescription('twofa'); loadPolicyExample('and(pk(Alice),or(and(pk(Bob),hash160(6c60f404f8167a38fc70eaf8aa17ac351023bef8)),older(52560)))', 'twofa')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">2FA + Backup</button>
                        <button onclick="showPolicyDescription('hodl'); loadPolicyExample('or(9@pk(Alice),and(thresh(3,pk(Bob),pk(Charlie),pk(Eva),pk(Frank)),older(52560)))', 'hodl')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">HODL Wallet</button>
                        <button onclick="showPolicyDescription('timelocked_thresh'); loadPolicyExample('and(thresh(2,pk(Alice),pk(Bob),pk(Charlie)),after(1767225600))', 'timelocked_thresh')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">Timelocked Multisig</button>
                        <button onclick="showPolicyDescription('atomic_swap'); loadPolicyExample('and(pk(Alice),or(and(pk(Bob),sha256(e258d248fda94c63753607f7c4494ee0fcbe92f1a76bfdac795c9d84101eb317)),older(144)))', 'atomic_swap')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">Atomic Swap</button>                       
                        <button onclick="showPolicyDescription('xonly'); loadPolicyExample('pk(David)', 'xonly')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">David (Taproot)</button>                        
                        <button onclick="showPolicyDescription('multi_branch'); loadPolicyExample('or(pk(David),or(pk(Helen),pk(Uma)))', 'multi_branch', 'taproot-keypath')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">Multi-Branch OR (Taproot)</button>
                        <button onclick="showPolicyDescription('lightning_channel'); loadPolicyExample('or(and(pk(David),pk(Helen)),or(and(pk(DavidTimeout),older(1008)),and(pk(HelenTimeout),older(1008))))', 'lightning_channel', 'taproot-multi')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">Lightning Channel (Taproot)</button>
                        <button onclick="showPolicyDescription('inheritance_vault'); loadPolicyExample('or(pk(David),and(thresh(2,pk(Uma),pk(VaultXOnly1),pk(VaultXOnly2)),older(26280)))', 'inheritance_vault', 'taproot-keypath')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">Inheritance Vault (Taproot)</button>

                    </div>
                    
                    <!-- Policy context section inside the left column -->
                    <div style="margin-top: 20px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600; color: var(--text-secondary);">Policy context:</label>
                        <div class="radio-group" style="display: flex; gap: 20px; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
                                <input type="radio" name="policy-context" value="legacy" style="margin: 0;">
                                <span style="font-size: 13px;">Legacy (p2SH)</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
                                <input type="radio" name="policy-context" value="segwit" checked style="margin: 0;">
                                <span style="font-size: 13px;">Segwit v0 (p2WSH)</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
                                <input type="radio" name="policy-context" value="taproot" style="margin: 0;">
                                <span style="font-size: 13px;">Taproot (Single leaf / Key)</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
                                <input type="radio" name="policy-context" value="taproot-multi" style="margin: 0;">
                                <span style="font-size: 13px;">Taproot (Script path)</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
                                <input type="radio" name="policy-context" value="taproot-keypath" style="margin: 0;">
                                <span style="font-size: 13px;">Taproot (Key path + script path)</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="policy-description-panel" style="flex: 0 0 300px; width: 300px; background: var(--secondary-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; display: none; overflow-wrap: break-word; word-wrap: break-word;" id="policy-description">
                    <div class="description-content">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color);">
                            <h5 style="margin: 0; color: var(--accent-color); font-size: 14px;" id="policy-title">📄 Single Key Policy NEW</h5>
                            <span style="cursor: pointer; font-family: monospace; font-size: 14px; color: var(--text-secondary); user-select: none;" onclick="togglePolicyDescription()" id="policy-toggle">[-]</span>
                        </div>
                        <div id="policy-expand-hint" style="display: none; color: var(--text-muted); font-size: 13px; font-style: italic; margin-bottom: 8px;">expand to see description</div>
                        <div id="policy-content">
                            <p style="margin: 0; color: var(--secondary-text); font-size: 13px; line-height: 1.4;">Click any policy example button to learn about its spending conditions and use cases.</p>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
        
        <div class="input-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <label for="expression-input" style="font-weight: 600; color: var(--text-secondary);">Miniscript:</label>
                <div style="display: flex; align-items: center; gap: 0px;">
                    <button id="key-names-toggle" onclick="toggleKeyNames()" style="background: none; border: none; padding: 4px; margin: 0; cursor: pointer; font-size: 16px; color: var(--text-secondary); display: flex; align-items: center; border-radius: 3px;" title="Show key names" onmouseover="this.style.backgroundColor='var(--button-secondary-bg)'" onmouseout="this.style.backgroundColor='transparent'">
                        🏷️
                    </button>
                    <button id="extract-keys-btn" style="background: none; border: none; padding: 4px; margin: 0; cursor: pointer; font-size: 16px; color: var(--text-secondary); display: flex; align-items: center; border-radius: 3px;" title="Extract keys from expression" onmouseover="this.style.backgroundColor='var(--button-secondary-bg)'" onmouseout="this.style.backgroundColor='transparent'">
                        🔑
                    </button>
                    <button id="format-miniscript-btn" style="background: none; border: none; padding: 4px; margin: 0; cursor: pointer; font-size: 16px; color: var(--text-secondary); display: flex; align-items: center; border-radius: 3px;" title="Format expression with indentation" onmouseover="this.style.backgroundColor='var(--button-secondary-bg)'" onmouseout="this.style.backgroundColor='transparent'">
                        📐
                    </button>
                    <button onclick="removeMiniscriptExtraChars()" style="background: none; border: none; padding: 4px; margin: 0; cursor: pointer; font-size: 16px; color: var(--text-secondary); display: flex; align-items: center; border-radius: 3px;" title="Remove extra characters" onmouseover="this.style.backgroundColor='var(--button-secondary-bg)'" onmouseout="this.style.backgroundColor='transparent'">
                        🧹
                    </button>
                    <button id="lift-miniscript-btn" onclick="liftMiniscriptToPolicy()" style="background: none; border: none; padding: 4px; margin: 0; cursor: pointer; font-size: 16px; color: var(--text-secondary); display: flex; align-items: center; border-radius: 3px;" title="Lift to Policy" onmouseover="this.style.backgroundColor='var(--button-secondary-bg)'" onmouseout="this.style.backgroundColor='transparent'">
                        ⬆️
                    </button>
                    <button onclick="copyMiniscriptExpression()" style="background: none; border: none; padding: 4px; margin: 0; cursor: pointer; font-size: 16px; color: var(--text-secondary); display: flex; align-items: center; border-radius: 3px;" title="Copy miniscript expression" onmouseover="this.style.backgroundColor='var(--button-secondary-bg)'" onmouseout="this.style.backgroundColor='transparent'">
                        📋
                    </button>
                    <button onclick="shareMiniscriptExpression(event)" style="background: none; border: none; padding: 4px; margin: 0; cursor: pointer; font-size: 16px; color: var(--text-secondary); display: flex; align-items: center; border-radius: 3px;" title="Share miniscript via URL" onmouseover="this.style.backgroundColor='var(--button-secondary-bg)'" onmouseout="this.style.backgroundColor='transparent'">
                        🔗
                    </button>
                </div>
            </div>
            <div 
                id="expression-input" 
                contenteditable="true"
                spellcheck="false"
                class="miniscript-editor"
            ></div>
            
            <!-- Debug mode toggle for Miniscript tab -->

            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-top: 15px;">
                <div class="button-group">
                    <button id="compile-btn" class="primary-btn">🔨 Compile</button>
                    <button id="save-btn" class="secondary-btn">💾 Save</button>
                    <button id="load-btn" class="secondary-btn">📂 Load</button>
                    <button id="clear-btn" class="secondary-btn">🗑️ Clear</button>
                </div>
                <div class="auto-compile-container" style="display: flex; align-items: center; gap: 8px;">
                    <span style="color: var(--text-secondary); font-size: 14px;">Auto compile examples</span>
                    <label class="toggle-switch" title="Toggle auto-compilation when loading examples or saved expressions">
                        <input type="checkbox" id="auto-compile-miniscript">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            
            <!-- Miniscript error messages -->
            <div id="miniscript-messages" style="margin-top: 15px;"></div>
            
            <!-- Miniscript description panel aligned with examples -->
            <div style="display: flex; gap: 20px; align-items: flex-start; margin-top: 15px;">
                <div style="flex: 1;">
                    <h4 style="margin-bottom: 10px; color: var(--text-secondary); font-weight: 600; font-size: inherit;">Basic examples:</h4>
                    <div class="button-group" style="align-items: flex-start;" id="miniscript-buttons-start">
                        <button onclick="showMiniscriptDescription('pkh'); loadExample('pkh(Alice)', 'pkh')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">Pay-to-pubkey-hash</button>
                        <button onclick="showMiniscriptDescription('wrap'); loadExample('c:pk_k(Alice)', 'wrap')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">Wrapped key</button>
                        <button onclick="showMiniscriptDescription('or_i'); loadExample('or_i(pk(Alice),pk(Bob))', 'or_i')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">OR with if-else</button>
                        <button onclick="showMiniscriptDescription('complex'); loadExample('and_v(v:pk(Alice),or_b(pk(Bob),s:pk(Charlie)))', 'complex')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">Alice AND (Bob OR Charlie)</button>
                        <button onclick="showMiniscriptDescription('timelock'); loadExample('and_v(v:pk(Alice),and_v(v:older(144),pk(Bob)))', 'timelock')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">Timelock: Alice AND (1 day + Bob)</button>
                        <button onclick="showMiniscriptDescription('after'); loadExample('and_v(v:pk(Alice),after(1767225600))', 'after')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">Absolute timelock</button>
                    </div>
                    <h4 style="margin: 20px 0 10px 0; color: var(--text-secondary); font-weight: 600; font-size: inherit;">Complex examples:</h4>
                    <div class="button-group" style="align-items: flex-start;">
                        <button onclick="showMiniscriptDescription('multisig'); loadExample('or_d(pk(Alice),or_d(pk(Bob),pk(Charlie)))', 'multisig')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">1-of-3 Multisig</button>
                        <button onclick="showMiniscriptDescription('recovery'); loadExample('or_d(pk(Alice),and_v(v:pk(Bob),older(1008)))', 'recovery')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">Recovery Wallet</button>
                        <button onclick="showMiniscriptDescription('hash'); loadExample('and_v(v:pk(Alice),or_d(pk(Bob),and_v(v:hash160(6c60f404f8167a38fc70eaf8aa17ac351023bef8),older(144))))', 'hash')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">Hash + Timelock</button>
                        <button onclick="showMiniscriptDescription('htlc_time'); loadExample('and_v(v:pk(Alice),or_d(pk(Bob),and_v(v:hash160(6c60f404f8167a38fc70eaf8aa17ac351023bef8),older(144))))', 'htlc_time')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">Time-based HTLC</button>
                        <button onclick="showMiniscriptDescription('htlc_hash'); loadExample('or_d(pk(Alice),and_v(v:hash160(6c60f404f8167a38fc70eaf8aa17ac351023bef8),and_v(v:pk(Bob),older(144))))', 'htlc_hash')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">Hash-based HTLC</button>
                        <button onclick="showMiniscriptDescription('full_descriptor'); loadExample('pk(MainnetKey)', 'full_descriptor')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">Full xpub descriptor</button>
                        <button onclick="showMiniscriptDescription('hd_derivation'); loadExample('pk([C8FE8D4F/48h/1h/123h/2h]tpubDDEe6Dc3LW1JEUzExDRZ3XBzcAzYxMTfVU5KojsTwXoJ4st6LzqgbFZ1HhDBdTptjXH9MwgdYG4K7MNJBfQktc6AoS8WeAWFDHwDTu99bZa/1/*)', 'hd_derivation')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">🗝️ HD Wallet Derivation</button>                                               
                        <button onclick="showMiniscriptDescription('range_descriptor'); loadExample('pk(RangeKey)', 'range_descriptor')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">Multipath range <1;0>/*</button>
                        <button onclick="showMiniscriptDescription('vault_complex'); loadExample('or_i(or_i(or_i(or_i(and_v(vc:or_i(pk_h(VaultKey1),pk_h(VaultKey4)),after(1753305229)),and_v(or_c(pkh(VaultKey6),v:thresh(2,pkh(VaultKey10),a:pkh(VaultKey15),a:pkh(VaultKey7),a:pkh(VaultKey2),a:pkh(VaultKey5))),after(1753298029))),and_v(or_c(pkh(VaultKey16),v:thresh(2,pkh(VaultKey11),a:pkh(VaultKey17),a:pkh(VaultKey8),a:pkh(VaultKey3))),after(1753290829))),and_v(or_c(pkh(VaultKey12),v:thresh(2,pkh(VaultKey13),a:pkh(VaultKey18),a:pkh(VaultKey9))),after(1753283629))),and_v(v:pk(VaultKey14),pk(VaultKey19)))', 'vault_complex')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">🏦 Complex Vault</button>
                        <button onclick="showMiniscriptDescription('joint_custody'); loadExample('andor(multi(2,jcKey1,jcKey2,jcKey3),or_i(and_v(v:pkh(saKey),after(1768176000)),thresh(2,pk(jcAg1),s:pk(jcAg2),s:pk(jcAg3),snl:after(1767225600))),and_v(v:thresh(2,pkh(recKey1),a:pkh(recKey2),a:pkh(recKey3)),after(1769817600)))', 'joint_custody')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">3-Key Joint Custody</button>
                        <button onclick="showMiniscriptDescription('liana_wallet'); loadExample('or_i(and_v(v:thresh(1,pkh(LianaDesc1),a:pkh(LianaDesc2),a:pkh(LianaDesc3)),older(20)),or_i(and_v(v:pkh(LianaDesc4),older(19)),or_d(multi(2,LianaDesc5,LianaDesc6),and_v(v:pkh(LianaDesc7),older(18)))))', 'liana_wallet')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">🦎 Liana Wallet</button>
                        <button onclick="showMiniscriptDescription('inheritance'); loadExample('and_v(v:pk(David),or_d(pk(Helen),and_v(v:pk(Ivan),older(52560))))', 'inheritance', 'taproot-multi')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">Inheritance (Taproot)</button>
                        <button onclick="showMiniscriptDescription('liquid_federation'); loadExample('or_d(multi_a(5,Fed1,Fed2,Fed3,Fed4,Fed5,Fed6,Fed7),and_v(v:multi_a(2,Emergency1,Emergency2,Emergency3),older(4032)))', 'liquid_federation', 'taproot-multi')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">Liquid Federation (Taproot)</button>
                        <button onclick="showMiniscriptDescription('taproot_multibranch'); loadExample('or_d(pk(Julia),and_v(v:pk(Karl),older(144)))', 'taproot_multibranch', 'taproot-multi')" class="secondary-btn" style="font-size: 13px; padding: 6px 12px;">🌳 Multi-Branch (Taproot)</button>

                    </div>
                    
                    <!-- Miniscript context section inside the left column -->
                    <div style="margin-top: 20px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600; color: var(--text-secondary);">Miniscript context:</label>
                        <div class="radio-group" style="display: flex; gap: 20px; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
                                <input type="radio" name="context" value="legacy" style="margin: 0;">
                                <span style="font-size: 13px;">Legacy (p2SH)</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
                                <input type="radio" name="context" value="segwit" checked style="margin: 0;">
                                <span style="font-size: 13px;">Segwit v0 (p2WSH)</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
                                <input type="radio" name="context" value="taproot" style="margin: 0;">
                                <span style="font-size: 13px;">Taproot (Single leaf / Key)</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
                                <input type="radio" name="context" value="taproot-multi" style="margin: 0;">
                                <span style="font-size: 13px;">Taproot (Script path)</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
                                <input type="radio" name="context" value="taproot-keypath" style="margin: 0;">
                                <span style="font-size: 13px;">Taproot (Key path + script path)</span>
                            </label>
                        </div>
                    </div>

                </div>
                <div class="miniscript-description-panel" style="flex: 0 0 300px; width: 300px; background: var(--secondary-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; display: none; overflow-wrap: break-word; word-wrap: break-word;" id="miniscript-description">
                    <div class="description-content">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color);">
                            <h5 style="margin: 0; color: var(--accent-color); font-size: 14px;" id="miniscript-title">⚙️ Single Key Miniscript</h5>
                            <span style="cursor: pointer; font-family: monospace; font-size: 14px; color: var(--text-secondary); user-select: none;" onclick="toggleMiniscriptDescription()" id="miniscript-toggle">[-]</span>
                        </div>
                        <div id="miniscript-expand-hint" style="display: none; color: var(--text-muted); font-size: 13px; font-style: italic; margin-bottom: 8px;">expand to see description</div>
                        <div id="miniscript-content">
                            <p style="margin: 0; color: var(--secondary-text); font-size: 13px; line-height: 1.4;">Click any miniscript example button to learn about its structure and Bitcoin Script patterns.</p>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
        
        <div class="results-section" id="results" style="margin-bottom: 20px;">
        </div>
        
        <details style="margin-bottom: 20px;">
            <summary style="cursor: pointer; font-weight: 600; color: var(--text-secondary); margin-bottom: 10px; font-size: 16px;">🔑 Key variables</summary>
            <div style="background: var(--info-bg); padding: 20px; border-radius: 8px; margin-top: 10px; border: 1px solid var(--border-color);">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                    <p style="margin: 0; color: var(--text-muted); flex: 1;">Define key variables to use names like "Alice" and "Bob". Use public keys only!</p>
                    <div style="display: flex; flex-direction: column; gap: 4px; margin-left: 10px; flex-shrink: 0;">
                        <button onclick="compiler.restoreDefaultKeys()" class="secondary-btn" style="padding: 8px 12px; font-size: 13px;">🔄 Restore defaults</button>
                        <button onclick="compiler.clearAllKeys()" class="danger-btn" style="padding: 8px 12px; font-size: 13px;">🗑️ Clear all</button>
                    </div>
                </div>
                
                <div class="add-key-form">
                    <input type="text" id="key-name-input" placeholder="Key name (e.g., Alice)" maxlength="20">
                    <input type="text" id="key-value-input" placeholder="Key value (any format)">
                    <div style="display: flex; gap: 10px;">
                        <button id="add-key-btn" class="primary-btn" style="padding: 8px 12px; font-size: 13px; flex: 1;">➕ Add key</button>
                        <button onclick="generateKey()" class="secondary-btn" style="padding: 8px 12px; font-size: 13px; flex: 1;">🎲 Generate</button>
                    </div>
                </div>
                
                <div class="key-type-panel" style="margin-top: 15px; padding: 15px; background: var(--secondary-bg); border-radius: 8px; border: 1px solid var(--border-color);">
                    <h4 style="margin: 0 0 12px 0; color: var(--text-color); font-size: 14px;">Key type generation:</h4>
                    <div class="radio-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-color); cursor: pointer;">
                            <input type="radio" name="keyType" value="compressed" checked style="margin: 0;">
                            <span>Compressed Public Keys</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-color); cursor: pointer;">
                            <input type="radio" name="keyType" value="xonly" style="margin: 0;">
                            <span>X-only Keys (Taproot)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-color); cursor: pointer;">
                            <input type="radio" name="keyType" value="xpub" style="margin: 0;">
                            <span>Extended Keys (xpub)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-color); cursor: pointer;">
                            <input type="radio" name="keyType" value="tpub" style="margin: 0;">
                            <span>Testnet Keys (tpub)</span>
                        </label>
                    </div>
                </div>
                
                <div id="key-variables-list" style="margin-top: 15px;">
                    <p style="color: var(--text-muted); font-style: italic; font-size: 14px;">No key variables defined.</p>
                </div>
            </div>
        </details>

        <details style="margin-bottom: 20px;">
            <summary style="cursor: pointer; font-weight: 600; color: var(--text-secondary); margin-bottom: 10px; font-size: 16px;">💾 Saved policies</summary>
            <div style="background: var(--info-bg); padding: 20px; border-radius: 8px; margin-top: 10px; border: 1px solid var(--border-color);">
                <div id="policies-list">
                    <p style="color: var(--text-muted); font-style: italic; font-size: 14px;">No saved policies yet.</p>
                </div>
            </div>
        </details>

        <details style="margin-bottom: 20px;">
            <summary style="cursor: pointer; font-weight: 600; color: var(--text-secondary); margin-bottom: 10px; font-size: 16px;">📝 Saved miniscript</summary>
            <div style="background: var(--info-bg); padding: 20px; border-radius: 8px; margin-top: 10px; border: 1px solid var(--border-color);">
                <div id="expressions-list">
                    <p style="color: var(--text-muted); font-style: italic; font-size: 14px;">No saved expressions yet.</p>
                </div>
            </div>
        </details>
        
        <details style="margin-bottom: 20px;">
            <summary style="cursor: pointer; font-weight: 600; color: var(--text-secondary); margin-bottom: 10px; font-size: 16px;">📘 Policy reference</summary>
            <div style="background: var(--info-bg); padding: 20px; border-radius: 8px; margin-top: 10px; border: 1px solid var(--border-color);">
                
                <h3 style="color: var(--accent-color); border-bottom: 2px solid var(--border-color); padding-bottom: 8px; font-size: 18px;">📖 What is Policy Language?</h3>
                
                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <p style="margin: 0; color: var(--text-color); font-size: 14px; line-height: 1.6;">
                        <strong>Policy Language</strong> is a high-level, human-readable way to describe Bitcoin spending conditions. It's designed for non-technical users to express complex logic like "Alice can spend immediately, OR Bob can spend after 1 week, OR any 2 of 3 trustees can spend." The policy compiler automatically converts these intuitive expressions into optimized miniscript and Bitcoin Script.
                    </p>
                    <p style="margin: 10px 0 0 0; color: var(--text-muted); font-size: 13px;">
                        <strong>Key benefits:</strong> Natural language syntax • Automatic optimization • Error prevention • Supports all Bitcoin script features
                    </p>
                </div>
                
                <h3 style="color: var(--accent-color); border-bottom: 2px solid var(--border-color); padding-bottom: 8px; font-size: 18px;">🔑 Authentication Functions</h3>
                
                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        pk(key) - Public Key Signature
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Requires a digital signature from the specified public key.<br>
                        <strong>When to use:</strong> Single-user wallets, simple ownership, hot wallets.<br>
                        <strong>Key formats:</strong> Variable names (Alice), hex pubkeys (02abc...), or xpub descriptors ([fingerprint/path]xpub...)<br>
                        <strong>Example:</strong> <code>pk(Alice)</code> - Only Alice can spend<br>
                        <strong>Why choose:</strong> Most efficient option (34 bytes), compiles directly to CHECKSIG.
                    </p>
                </div>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        pkh(key) - Public Key Hash (P2PKH Style)
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Requires revealing the public key AND providing a signature.<br>
                        <strong>When to use:</strong> Traditional Bitcoin addresses, privacy until spending, shorter scriptPubKeys.<br>
                        <strong>Trade-offs:</strong> Slightly less efficient than pk() but hides the public key until spending.<br>
                        <strong>Example:</strong> <code>pkh(Alice) - Alice must reveal her key and sign<br>
                        <strong>Why choose:</strong> Standard address format, privacy benefits, 20-byte hash storage.
                    </p>
                </div>

                <h3 style="color: var(--accent-color); border-bottom: 2px solid var(--border-color); padding-bottom: 8px; margin-top: 25px; font-size: 18px;">⏰ Time-based Conditions</h3>
                
                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        after(n) - Absolute Timelock
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Can only spend after a specific block height or Unix timestamp.<br>
                        <strong>When to use:</strong> Scheduled payments, vesting schedules, inheritance planning, time-delayed vaults.<br>
                        <strong>Format:</strong> Block height (n < 500000000) or Unix timestamp (n ≥ 500000000)<br>
                        <strong>Examples:</strong> <code>after(800000) - after block 800k, <code>after(1767225600) - after Jan 1, 2026<br>
                        <strong>Why choose:</strong> Enforces global time constraints, perfect for future-dated transactions.
                    </p>
                </div>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        older(n) - Relative Timelock
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Must wait n blocks after UTXO creation before spending.<br>
                        <strong>When to use:</strong> Recovery paths, Lightning channels, forced hodling, vault timeouts.<br>
                        <strong>Common values:</strong> 144 (1 day), 1008 (1 week), 4320 (1 month)<br>
                        <strong>Example:</strong> <code>or(pk(Alice),and(pk(Bob),older(144))) - Bob can recover after 1 day<br>
                        <strong>Why choose:</strong> Creates delays relative to UTXO age, ideal for timeout-based recovery.
                    </p>
                </div>

                <h3 style="color: var(--accent-color); border-bottom: 2px solid var(--border-color); padding-bottom: 8px; margin-top: 25px; font-size: 18px;">🔐 Hash-based Conditions</h3>
                
                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        sha256(h) - SHA256 Preimage
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Requires revealing data that produces the given SHA256 hash.<br>
                        <strong>When to use:</strong> Atomic swaps, HTLCs, payment channels, proof of knowledge.<br>
                        <strong>Format:</strong> 64 hex characters (32-byte hash)<br>
                        <strong>Example:</strong> <code>and(pk(Alice),sha256(abc123...)) - Alice + secret knowledge<br>
                        <strong>Why choose:</strong> Most common hash function, widely supported, secure.
                    </p>
                </div>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        hash256(h) - Double SHA256
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Requires preimage for SHA256(SHA256(data)).<br>
                        <strong>When to use:</strong> Bitcoin-native hashing, compatibility with Bitcoin's block/transaction hashing.<br>
                        <strong>Example:</strong> Cross-chain swaps with Bitcoin-style chains<br>
                        <strong>Why choose:</strong> Standard Bitcoin hashing, resistance to length extension attacks.
                    </p>
                </div>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        hash160(h) - Bitcoin Address Hash
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Requires preimage for RIPEMD160(SHA256(data)).<br>
                        <strong>Format:</strong> 40 hex characters (20-byte hash)<br>
                        <strong>When to use:</strong> Bitcoin address generation, compatibility with existing systems.<br>
                        <strong>Why choose:</strong> Standard for Bitcoin addresses, compact 20-byte representation.
                    </p>
                </div>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        ripemd160(h) - RIPEMD160 Hash
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Requires preimage for RIPEMD160 hash.<br>
                        <strong>Format:</strong> 40 hex characters (20-byte hash)<br>
                        <strong>When to use:</strong> Specialized use cases, rarely used alone.<br>
                        <strong>Why choose:</strong> Part of Bitcoin's cryptographic suite, specific compatibility needs.
                    </p>
                </div>

                <h3 style="color: var(--accent-color); border-bottom: 2px solid var(--border-color); padding-bottom: 8px; margin-top: 25px; font-size: 18px;">🔗 Logic Operators</h3>
                
                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        and(X,Y) - Both Conditions Required
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Both X AND Y must be satisfied to spend.<br>
                        <strong>When to use:</strong> Multi-signature wallets, complex authorization, dual requirements.<br>
                        <strong>Optimization tip:</strong> Order matters - put the more likely to fail condition first.<br>
                        <strong>Example:</strong> <code>and(pk(Alice),pk(Bob)) - requires both signatures<br>
                        <strong>Why choose:</strong> Clear intent, automatic optimization to and_v() miniscript.
                    </p>
                </div>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        or(X,Y) - Either Condition Works
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Either X OR Y can satisfy (or both).<br>
                        <strong>When to use:</strong> Backup paths, multiple spending methods, recovery options.<br>
                        <strong>Auto-optimization:</strong> Compiler chooses optimal miniscript combinator (or_b, or_c, or_d, or_i).<br>
                        <strong>Example:</strong> <code>or(pk(Alice),and(pk(Bob),older(144))) - Alice immediately OR Bob after delay<br>
                        <strong>Why choose:</strong> Flexible spending paths, compiler handles complexity.
                    </p>
                </div>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        thresh(k,X,Y,Z,...) - K-of-N Threshold
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Exactly k out of n conditions must be satisfied.<br>
                        <strong>When to use:</strong> Flexible multisig, mixed condition types, complex governance.<br>
                        <strong>Advantage:</strong> More flexible than multi() - works with any policy fragments, not just keys.<br>
                        <strong>Examples:</strong> <code>thresh(2,pk(Alice),pk(Bob),pk(Charlie))</code> for 2-of-3, <code>thresh(2,pk(Alice),older(100),sha256(...))</code><br>
                        <strong>Why choose:</strong> Ultimate flexibility, can combine different condition types.
                    </p>
                </div>

                <h3 style="color: var(--accent-color); border-bottom: 2px solid var(--border-color); padding-bottom: 8px; margin-top: 25px; font-size: 18px;">⚡ Optimization Features</h3>
                
                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        n@ - Probability Weights
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Indicates relative probability/frequency of use for optimization.<br>
                        <strong>When to use:</strong> When you know which spending path will be used most often.<br>
                        <strong>Benefit:</strong> Compiler optimizes for smaller, cheaper transactions on common paths.<br>
                        <strong>Examples:</strong><br>
                        • <code>or(99@pk(Alice),pk(Bob)) - Alice spends 99% of the time<br>
                        • <code>or(9@pk(Alice),pk(Bob)) - Alice 9x more likely than Bob<br>
                        • <code>thresh(2,10@pk(Alice),10@pk(Bob),1@pk(Charlie)) - Charlie rarely participates<br>
                        <strong>How it works:</strong> Only relative ratios matter, any scale works (1-10, percentages, weights).
                    </p>
                </div>

                <div style="background: var(--container-bg); padding: 15px; border-radius: 6px; margin: 20px 0; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">Important Constraints</h4>
                    <ul style="margin: 10px 0; padding-left: 20px; color: var(--text-color); font-size: 13px; line-height: 1.8;">
                        <li><strong>Satisfiability:</strong> All policies must be satisfiable (no impossible conditions like <code>and(pk(A),0)</code>)</li>
                        <li><strong>Script Limits:</strong> Maximum 520 bytes for P2SH, 10,000 bytes for P2WSH, no limit for Taproot</li>
                        <li><strong>Time Format:</strong> Block heights (small numbers like 144), Unix timestamps (large numbers like 1767225600)</li>
                        <li><strong>Key Format:</strong> Variable names (Alice), hex pubkeys (02abc...), or descriptors ([fingerprint/path]xpub...)</li>
                        <li><strong>Compilation:</strong> Policy → Miniscript → Bitcoin Script (automatic optimization at each stage)</li>
                    </ul>
                </div>

                <p style="margin: 10px 0; font-size: 13px; color: var(--text-muted);">
                    <strong>Reference:</strong> <a href="https://bitcoin.sipa.be/miniscript/" target="_blank" style="color: var(--border-focus); text-decoration: none;">https://bitcoin.sipa.be/miniscript/</a>
                </p>
            </div>
        </details>

        <details style="margin-bottom: 20px;">
            <summary style="cursor: pointer; font-weight: 600; color: var(--text-secondary); margin-bottom: 10px; font-size: 16px;">📚 Miniscript reference</summary>
            <div style="background: var(--info-bg); padding: 20px; border-radius: 8px; margin-top: 10px; border: 1px solid var(--border-color);">
                
                <h3 style="color: var(--accent-color); border-bottom: 2px solid var(--border-color); padding-bottom: 8px; font-size: 18px;">⚙️ What is Miniscript?</h3>
                
                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <p style="margin: 0; color: var(--text-color); font-size: 14px; line-height: 1.6;">
                        <strong>Miniscript</strong> is a structured representation of Bitcoin Script that's designed to be analyzable, composable, and optimizable. While Policy is human-readable, Miniscript is the precise, unambiguous intermediate language that compiles directly to Bitcoin Script. It explicitly defines how Bitcoin opcodes combine, ensuring scripts are secure, efficient, and predictable.
                    </p>
                    <p style="margin: 10px 0 0 0; color: var(--text-muted); font-size: 13px;">
                        <strong>Key features:</strong> Precise script control • Fragment composability • Size/cost analysis • Security guarantees • Optimization opportunities
                    </p>
                </div>
                
                <h3 style="color: var(--accent-color); border-bottom: 2px solid var(--border-color); padding-bottom: 8px; font-size: 18px;">🔑 Key-based Fragments</h3>
                
                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        pk(key) - Simple Public Key Check
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Requires a signature from the specified public key.<br>
                        <strong>Script:</strong> <code>&lt;pubkey&gt; CHECKSIG</code><br>
                        <strong>When to use:</strong> Single-user wallets, simple ownership where one person controls funds.<br>
                        <strong>Example:</strong> <code>pk(Alice) - Only Alice can spend<br>
                        <strong>Why choose this:</strong> Most efficient for single-key spending. Minimal script size (34 bytes for compressed key).
                    </p>
                </div>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        pkh(key) - Public Key Hash
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Requires revealing the public key AND a signature. Key must hash to the given hash160.<br>
                        <strong>Script:</strong> <code>DUP HASH160 &lt;hash&gt; EQUALVERIFY CHECKSIG</code><br>
                        <strong>When to use:</strong> Traditional Bitcoin addresses (P2PKH style), when you want shorter scriptPubKeys.<br>
                        <strong>Example:</strong> <code>pkh(Alice) - Alice must reveal her key and sign<br>
                        <strong>Why choose this:</strong> Shorter scriptPubKey (only 20-byte hash stored), privacy until spending, standard address format.
                    </p>
                </div>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        pk_k(key) - Raw Key on Stack
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Like pk() but expects the key already on stack (doesn't push it).<br>
                        <strong>Script:</strong> <code>CHECKSIG</code> (key must be on stack already)<br>
                        <strong>When to use:</strong> Advanced scripts where key comes from elsewhere (e.g., from a hash preimage).<br>
                        <strong>Example:</strong> Used internally by compiler for optimizations<br>
                        <strong>Why choose this:</strong> Saves bytes when key is already available, used in complex nested structures.
                    </p>
                </div>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        pk_h(key) - Hashed Key Check
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Like pkh() but doesn't duplicate the key (expects it on stack).<br>
                        <strong>Script:</strong> <code>HASH160 &lt;hash&gt; EQUALVERIFY CHECKSIG</code><br>
                        <strong>When to use:</strong> Internal optimization when key is already available.<br>
                        <strong>Example:</strong> Used in nested constructs by compiler<br>
                        <strong>Why choose this:</strong> Saves a DUP operation when key is already on stack.
                    </p>
                </div>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        0 - Always False
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Pushes false (0) onto the stack.<br>
                        <strong>Script:</strong> <code>0</code><br>
                        <strong>When to use:</strong> Creating provably unspendable branches or testing.<br>
                        <strong>Example:</strong> <code>or_i(pk(Alice),0) - Only Alice can spend<br>
                        <strong>Why use:</strong> Explicit false conditions, often for disabled branches.
                    </p>
                </div>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        1 - Always True  
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Pushes true (1) onto the stack.<br>
                        <strong>Script:</strong> <code>1</code><br>
                        <strong>When to use:</strong> Creating always satisfiable conditions or testing.<br>
                        <strong>Example:</strong> <code>and_v(1,pk(Alice)) - Effectively just requires Alice<br>
                        <strong>Why use:</strong> Placeholder conditions or always-satisfied requirements.
                    </p>
                </div>

                <h3 style="color: var(--accent-color); border-bottom: 2px solid var(--border-color); padding-bottom: 8px; margin-top: 25px; font-size: 18px;">⏰ Time-based Fragments</h3>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        after(n) - Absolute Timelock
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Can only spend after block height or Unix timestamp n.<br>
                        <strong>Script:</strong> <code>&lt;n&gt; CHECKLOCKTIMEVERIFY</code><br>
                        <strong>When to use:</strong> Scheduled payments, vesting, inheritance planning, time-delayed vaults.<br>
                        <strong>Example:</strong> <code>and_v(v:pk(Alice),after(1767225600)) - Alice can spend after Jan 1, 2026<br>
                        <strong>Why choose this:</strong> Enforces spending cannot happen before specific time. Uses transaction nLockTime field.
                    </p>
                </div>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        older(n) - Relative Timelock
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Must wait n blocks after UTXO creation before spending.<br>
                        <strong>Script:</strong> <code>&lt;n&gt; CHECKSEQUENCEVERIFY</code><br>
                        <strong>When to use:</strong> Lightning channels, vault recovery paths, forced hodling, gradual release.<br>
                        <strong>Example:</strong> <code>or(pk(Alice),and(pk(Bob),older(144))) - Bob can spend after 1 day<br>
                        <strong>Why choose this:</strong> Creates delay relative to when UTXO was created. Perfect for timeout-based recovery.
                    </p>
                </div>

                <h3 style="color: var(--accent-color); border-bottom: 2px solid var(--border-color); padding-bottom: 8px; margin-top: 25px; font-size: 18px;">🔐 Hash-based Fragments</h3>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        sha256(hash) - SHA256 Preimage
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Requires revealing data that hashes to the given SHA256 hash.<br>
                        <strong>Script:</strong> <code>SIZE 32 EQUALVERIFY SHA256 &lt;hash&gt; EQUAL</code><br>
                        <strong>When to use:</strong> Atomic swaps, HTLCs, proof of knowledge, cross-chain bridges.<br>
                        <strong>Example:</strong> <code>and(pk(Alice),sha256(abc123...)) - Alice + secret<br>
                        <strong>Why choose this:</strong> Most common hash function in Bitcoin, 32-byte preimages, widely supported.
                    </p>
                </div>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        hash256(hash) - Double SHA256
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Requires preimage for SHA256(SHA256(data)).<br>
                        <strong>Script:</strong> <code>SIZE 32 EQUALVERIFY HASH256 &lt;hash&gt; EQUAL</code><br>
                        <strong>When to use:</strong> Bitcoin-native hashing (used for block headers, txids).<br>
                        <strong>Example:</strong> Cross-chain swaps with Bitcoin-style chains<br>
                        <strong>Why choose this:</strong> Standard Bitcoin hashing, slightly more secure against length extension.
                    </p>
                </div>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        hash160(hash) - RIPEMD160(SHA256)
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Requires preimage for RIPEMD160(SHA256(data)).<br>
                        <strong>Script:</strong> <code>SIZE 32 EQUALVERIFY HASH160 &lt;hash&gt; EQUAL</code><br>
                        <strong>When to use:</strong> Bitcoin address-style hashing, 20-byte hashes for smaller scripts.<br>
                        <strong>Example:</strong> <code>and(pk(Alice),hash160(6c60f404...)) - Common in 2FA setups<br>
                        <strong>Why choose this:</strong> Smaller hash (20 bytes), used in Bitcoin addresses, good for space optimization.
                    </p>
                </div>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        ripemd160(hash) - RIPEMD160 Hash
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Requires preimage for RIPEMD160(data).<br>
                        <strong>Script:</strong> <code>SIZE 32 EQUALVERIFY RIPEMD160 &lt;hash&gt; EQUAL</code><br>
                        <strong>When to use:</strong> Alternative hash function, legacy compatibility.<br>
                        <strong>Example:</strong> Rarely used, mainly for specific protocols<br>
                        <strong>Why choose this:</strong> Different hash function for diversity, 20-byte output.
                    </p>
                </div>

                <h3 style="color: var(--accent-color); border-bottom: 2px solid var(--border-color); padding-bottom: 8px; margin-top: 25px; font-size: 18px;">🔀 OR Combinators - Choosing the Right One</h3>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        or_i(X,Y) - If/Else Branch Selection
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Spender chooses branch with 1 (left) or 0 (right) on stack.<br>
                        <strong>Script:</strong> <code>IF &lt;X&gt; ELSE &lt;Y&gt; ENDIF</code><br>
                        <strong>When to use:</strong> Two distinct spending paths, clean branch selection, vault tiers.<br>
                        <strong>Example:</strong> <code>or_i(pk(Alice),pk(Bob)) - Alice OR Bob can spend<br>
                        <strong>Why choose or_i:</strong> Most readable, explicit branch choice, good for user-facing options. Spender decides upfront which path to take.
                    </p>
                </div>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        or_d(X,Y) - Try Left First, Fallback to Right
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Tries X first; if X leaves 0, then tries Y.<br>
                        <strong>Script:</strong> <code>&lt;X&gt; IFDUP NOTIF &lt;Y&gt; ENDIF</code><br>
                        <strong>When to use:</strong> Primary path with automatic fallback, signature-or-timeout patterns.<br>
                        <strong>Example:</strong> <code>or_d(pk(Alice),and(pk(Bob),older(144))) - Alice primary, Bob backup<br>
                        <strong>Why choose or_d:</strong> Automatic fallback without explicit choice. Left branch "dissatisfies" gracefully to allow right branch.
                    </p>
                </div>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        or_c(X,Y) - Optimized for Signatures
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Specialized OR for pk/pkh combinations.<br>
                        <strong>Script:</strong> <code>&lt;X&gt; NOTIF &lt;Y&gt; ENDIF</code><br>
                        <strong>When to use:</strong> When left side is a signature check that can be "dissatisfied".<br>
                        <strong>Example:</strong> Used internally for optimizing signature-based ORs<br>
                        <strong>Why choose or_c:</strong> Most efficient for signature-based options. Compiler often chooses this automatically.
                    </p>
                </div>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        or_b(X,Y) - Boolean OR Logic
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Evaluates both branches, combines with boolean OR.<br>
                        <strong>Script:</strong> <code>&lt;X&gt; &lt;Y&gt; BOOLOR</code><br>
                        <strong>When to use:</strong> When you need both conditions evaluated (rare).<br>
                        <strong>Example:</strong> Complex boolean logic, both sides must execute<br>
                        <strong>Why choose or_b:</strong> Both branches always execute. Usually inefficient but sometimes necessary for specific logic.
                    </p>
                </div>

                <h3 style="color: var(--accent-color); border-bottom: 2px solid var(--border-color); padding-bottom: 8px; margin-top: 25px; font-size: 18px;">🔗 AND Combinators - Combining Conditions</h3>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        and_v(X,Y) - Verify Then Execute
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> X must be true (verified), then Y is evaluated.<br>
                        <strong>Script:</strong> <code>&lt;X&gt; VERIFY &lt;Y&gt;</code><br>
                        <strong>When to use:</strong> Most common AND. Signature + timelock, key + hash, any two conditions.<br>
                        <strong>Example:</strong> <code>and_v(v:pk(Alice),older(144)) - Alice after 1 day<br>
                        <strong>Why choose and_v:</strong> Clean, efficient, X doesn't leave anything on stack. Use when X is a "check" condition.
                    </p>
                </div>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        and_b(X,Y) - Boolean AND
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Both return boolean values, combined with AND.<br>
                        <strong>Script:</strong> <code>&lt;X&gt; &lt;Y&gt; BOOLAND</code><br>
                        <strong>When to use:</strong> When both sides produce boolean (0/1) results.<br>
                        <strong>Example:</strong> Combining hash checks or boolean conditions<br>
                        <strong>Why choose and_b:</strong> Both sides leave values on stack to be combined. Less common than and_v.
                    </p>
                </div>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        and_n(X,Y) - Conditional AND
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Uses NOTIF pattern for conditional execution.<br>
                        <strong>Script:</strong> <code>&lt;X&gt; NOTIF 0 ELSE &lt;Y&gt; ENDIF</code><br>
                        <strong>When to use:</strong> Internal optimization, rarely hand-written.<br>
                        <strong>Example:</strong> Compiler-generated for specific patterns<br>
                        <strong>Why choose and_n:</strong> Special cases where this pattern is more efficient.
                    </p>
                </div>

                <h3 style="color: var(--accent-color); border-bottom: 2px solid var(--border-color); padding-bottom: 8px; margin-top: 25px; font-size: 18px;">🎯 Threshold & Multisig</h3>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        thresh(k,X₁,...,Xₙ) - K-of-N Threshold
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Exactly k of the n conditions must be satisfied.<br>
                        <strong>Script:</strong> Complex combination of ADD and EQUAL checks<br>
                        <strong>When to use:</strong> Flexible multisig, mixed conditions (keys + timelocks + hashes).<br>
                        <strong>Example:</strong> <code>thresh(2,pk(A),pk(B),pk(C)) - Any 2 of 3 signers<br>
                        <strong>Why choose thresh:</strong> Most flexible threshold. Can mix different condition types, not just keys.
                    </p>
                </div>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        multi(k,key₁,...) - Classic Multisig
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Traditional Bitcoin multisig with CHECKMULTISIG.<br>
                        <strong>Script:</strong> <code>&lt;k&gt; &lt;key1&gt; ... &lt;keyn&gt; &lt;n&gt; CHECKMULTISIG</code><br>
                        <strong>When to use:</strong> Legacy compatibility, up to 3-of-3 in P2SH.<br>
                        <strong>Example:</strong> <code>multi(2,Alice,Bob,Charlie)</code><br>
                        <strong>Why choose multi:</strong> Most efficient for pure key-based multisig. Limited to 20 keys max.
                    </p>
                </div>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        multi_a(k,key₁,...) - Taproot Multisig
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Modern multisig using CHECKSIGADD (Taproot only).<br>
                        <strong>Script:</strong> Series of <code>CHECKSIGADD</code> operations<br>
                        <strong>When to use:</strong> Taproot scripts, more than 20 keys, batch validation.<br>
                        <strong>Example:</strong> <code>multi_a(11,key1,...,key20) - 11-of-20<br>
                        <strong>Why choose multi_a:</strong> No key limit, more efficient in Taproot, better for large multisigs.
                    </p>
                </div>

                <h3 style="color: var(--accent-color); border-bottom: 2px solid var(--border-color); padding-bottom: 8px; margin-top: 25px; font-size: 18px;">🎭 Wrappers - Modifying Behavior</h3>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        v: - Verify Wrapper
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Adds VERIFY, expression must be true or script fails.<br>
                        <strong>Script:</strong> <code>&lt;expr&gt; VERIFY</code><br>
                        <strong>When to use:</strong> Converting expressions for use in and_v, ensuring conditions are met.<br>
                        <strong>Example:</strong> <code>and_v(v:pk(Alice),older(144))</code><br>
                        <strong>Why use:</strong> Makes expression "unit type" - doesn't leave value on stack.
                    </p>
                </div>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        a: - Alt Stack Wrapper
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Temporarily stores value on alt stack.<br>
                        <strong>Script:</strong> <code>TOALTSTACK ... FROMALTSTACK</code><br>
                        <strong>When to use:</strong> Complex scripts needing temporary storage, threshold operations.<br>
                        <strong>Example:</strong> <code>thresh(2,pk(A),a:pk(B),a:pk(C))</code><br>
                        <strong>Why use:</strong> Prevents stack interference in complex evaluations.
                    </p>
                </div>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        s: - Swap Wrapper
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Swaps top two stack elements.<br>
                        <strong>Script:</strong> <code>SWAP &lt;expr&gt;</code><br>
                        <strong>When to use:</strong> Reordering stack for specific operations.<br>
                        <strong>Example:</strong> Internal compiler optimization<br>
                        <strong>Why use:</strong> Stack management in complex scripts.
                    </p>
                </div>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        c: - Checksig Wrapper
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Adds CHECKSIG to a key.<br>
                        <strong>Script:</strong> <code>&lt;key&gt; CHECKSIG</code><br>
                        <strong>When to use:</strong> Converting raw keys to signature checks.<br>
                        <strong>Example:</strong> <code>or_c(pk(A),v:pk(B))</code> uses this internally<br>
                        <strong>Why use:</strong> Type conversion for certain combinators.
                    </p>
                </div>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        d: - Dup-If Wrapper
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Duplicates if non-zero.<br>
                        <strong>Script:</strong> <code>DUP IF ... ENDIF</code><br>
                        <strong>When to use:</strong> or_d constructions, conditional duplication.<br>
                        <strong>Example:</strong> Used in <code>or_d</code> patterns<br>
                        <strong>Why use:</strong> Enables dissatisfaction in OR branches.
                    </p>
                </div>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        t: - True/False Wrapper
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Converts to 1 if true, 0 if false.<br>
                        <strong>Script:</strong> <code>IF 1 ELSE 0 ENDIF</code><br>
                        <strong>When to use:</strong> Normalizing boolean values.<br>
                        <strong>Example:</strong> <code>t:or_i(pk(A),pk(B))</code><br>
                        <strong>Why use:</strong> Ensures consistent 0/1 output.
                    </p>
                </div>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        j: - Size Check Wrapper
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Adds SIZE 0NOTEQUAL check (non-zero size).<br>
                        <strong>Script:</strong> <code>SIZE 0NOTEQUAL IF &lt;expr&gt; ENDIF</code><br>
                        <strong>When to use:</strong> Ensuring input has non-zero size before evaluation.<br>
                        <strong>Example:</strong> <code>j:pk(Alice) - Requires non-empty signature<br>
                        <strong>Why use:</strong> Malleability protection, ensuring witness data present.
                    </p>
                </div>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        n: - Nonzero Wrapper
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> Converts any non-zero value to 1.<br>
                        <strong>Script:</strong> <code>DUP 0NOTEQUAL</code><br>
                        <strong>When to use:</strong> Normalizing non-zero values to boolean true.<br>
                        <strong>Example:</strong> <code>n:older(100) - Ensures boolean output<br>
                        <strong>Why use:</strong> Type normalization for certain operations.
                    </p>
                </div>

                <h3 style="color: var(--accent-color); border-bottom: 2px solid var(--border-color); padding-bottom: 8px; margin-top: 25px; font-size: 18px;">🚀 Advanced Patterns</h3>

                <div style="margin: 15px 0; padding: 15px; background: var(--info-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">
                        andor(X,Y,Z) - Optimized (X AND Y) OR Z
                    </h4>
                    <p style="margin: 0; color: var(--text-color); font-size: 13px; line-height: 1.5;">
                        <strong>What it does:</strong> If X is satisfied, require Y; otherwise require Z.<br>
                        <strong>Script:</strong> Optimized combination avoiding redundant checks<br>
                        <strong>When to use:</strong> "If condition then require Y, else require Z" patterns.<br>
                        <strong>Example:</strong> <code>andor(pk(Alice),pk(Bob),and(pk(Charlie),older(144)))</code><br>
                        <strong>Why choose andor:</strong> More efficient than <code>or(and(X,Y),Z)</code> for this specific pattern.
                    </p>
                </div>

                <h3 style="color: var(--accent-color); border-bottom: 2px solid var(--border-color); padding-bottom: 8px; margin-top: 25px; font-size: 18px;">💡 Design Patterns & Best Practices</h3>

                <div style="margin: 20px 0; padding: 15px; background: var(--container-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-color); margin: 0 0 10px 0; font-size: 16px;">Common Patterns</h4>
                    <ul style="margin: 10px 0; padding-left: 20px; color: var(--text-color); font-size: 13px; line-height: 1.8;">
                        <li><strong>Hot Wallet + Cold Backup:</strong> <code>or(pk(Hot),and(pk(Cold),older(1008)))</code></li>
                        <li><strong>2FA with Timeout:</strong> <code>and(pk(User),or(pk(Service),older(52560)))</code></li>
                        <li><strong>Escrow:</strong> <code>or(and(pk(Buyer),pk(Seller)),pk(Arbiter))</code></li>
                        <li><strong>HTLC:</strong> <code>or(and(pk(Recipient),sha256(H)),and(pk(Sender),older(144)))</code></li>
                        <li><strong>Inheritance:</strong> <code>or(pk(Owner),and(pk(Heir),after(1798761600)))</code></li>
                        <li><strong>Vault:</strong> <code>or(and(pk(Hot),pk(Cold)),and(pk(Recovery),older(4320)))</code></li>
                    </ul>
                </div>

                <div style="background: var(--info-bg); padding: 15px; border-radius: 6px; margin: 20px 0; border: 1px solid var(--border-color);">
                    <h4 style="color: var(--text-secondary); margin: 0 0 15px 0; font-size: 15px;">Choosing Fragments</h4>
                    <ul style="margin: 10px 0; padding-left: 20px; color: var(--text-color); font-size: 13px; line-height: 1.8;">
                        <li><strong>Keys:</strong> Use <code>pk()</code> for simplicity, <code>pkh()</code> for privacy/compatibility</li>
                        <li><strong>Time:</strong> Use <code>after()</code> for absolute dates, <code>older()</code> for relative delays</li>
                        <li><strong>OR Logic:</strong> Use <code>or_i</code> for clear choices, <code>or_d</code> for primary/backup</li>
                        <li><strong>AND Logic:</strong> Use <code>and_v</code> for most cases, others for optimization</li>
                        <li><strong>Threshold:</strong> Use <code>thresh</code> for mixed conditions, <code>multi</code> for pure multisig</li>
                        <li><strong>Wrappers:</strong> Let compiler add them, use <code>v:</code> when needed for and_v</li>
                    </ul>
                </div>
                
                <p style="margin: 15px 0 10px 0; font-size: 14px; color: var(--text-muted);">
                    <strong>Note:</strong> Public keys must be 33-byte compressed hex strings (66 characters) for Legacy and Segwit v0, or 32-byte X-only keys (64 characters) for Taproot.
                    The compiler supports Legacy (p2SH), Segwit v0 (p2WSH), and Taproot contexts.
                </p>

                <p style="margin: 10px 0; font-size: 13px; color: var(--text-muted);">
                    <strong>Reference:</strong> <a href="https://bitcoin.sipa.be/miniscript/" target="_blank" style="color: var(--border-focus); text-decoration: none;">https://bitcoin.sipa.be/miniscript/</a>
                </p>
            </div>
        </details>

        <details style="margin-bottom: 20px;">
            <summary style="cursor: pointer; font-weight: 600; color: var(--text-secondary); margin-bottom: 10px; font-size: 16px;">💡 Tips & Quick Help</summary>
            <div style="background: var(--info-bg); padding: 20px; border-radius: 8px; margin-top: 10px; border: 1px solid var(--border-color);">
                <div style="display: grid; gap: 15px;">
                    <div class="tip-item">
                        <strong style="color: var(--text-color); font-size: 16px;">🏷️ Show key names:</strong>
                        <br>
                        <p style="margin: 4px 0 0 0; color: var(--text-color); font-size: 13px;">
                            Use the 🏷️ button to toggle between showing full public keys and variable names (Alice, Bob, etc.) in your expressions. Makes complex policies much easier to read and understand.
                        </p>
                    </div>
                    <div class="tip-item">
                        <strong style="color: var(--text-color); font-size: 16px;">🔑 Key management & extraction:</strong>
                        <br>
                        <p style="margin: 4px 0 0 0; color: var(--text-color); font-size: 13px;">
                            Use the 🔑 button to automatically detect keys in your expression and convert them to reusable variables. Works for hex values too. Also works from error messages - click "extract keys" from the error message itself to auto generate them. Detects public keys, xpubs, tpubs, and x-only keys. If an example fails to compile, go to "Key variables" section and use "Restore defaults" to reset Alice, Bob, Charlie, etc.
                        </p>
                    </div>
                    <div class="tip-item">
                        <strong style="color: var(--text-color); font-size: 16px;">📐 Format expressions:</strong>
                        <br>
                        <p style="margin: 4px 0 0 0; color: var(--text-color); font-size: 13px;">
                            Use the 📐 button to format long policy, miniscript expressions and scripts with proper indentation. Makes complex nested expressions easier to read and understand. Note: formatting is automatically cleaned during compilation to reflect the actual expression being compiled.
                        </p>
                    </div>
                    <div class="tip-item">
                        <strong style="color: var(--text-color); font-size: 16px;">🧹 Clean up text:</strong>
                        <br>
                        <p style="margin: 4px 0 0 0; color: var(--text-color); font-size: 13px;">
                            The 🧹 button removes extra whitespace and formatting from pasted expressions that prevent them from compiling successfully.
                        </p>
                    </div>
                    <div class="tip-item">
                        <strong style="color: var(--text-color); font-size: 16px;">💾 Save/Load expressions:</strong>
                        <br>
                        <p style="margin: 4px 0 0 0; color: var(--text-color); font-size: 13px;">
                            Save frequently used policies/expressions with the 💾 Save button. Saved items appear in their respective sections for quick reloading.
                        </p>
                    </div>
                    <div class="tip-item">
                        <strong style="color: var(--text-color); font-size: 16px;">🎲 Generate test keys:</strong>
                        <br>
                        <p style="margin: 4px 0 0 0; color: var(--text-color); font-size: 13px;">
                            Use the 🎲 Generate button in Key variables to create random test keys appropriate for your selected script context (xpub, compressed for Legacy/Segwit, X-only for Taproot). 
                        </p>
                    </div>
                    <div class="tip-item">
                        <strong style="color: var(--text-color); font-size: 16px;">🔄 Context auto-detection:</strong>
                        <br>
                        <p style="margin: 4px 0 0 0; color: var(--text-color); font-size: 13px;">
                            Script context automatically switches based on key types: compressed keys (66 chars) → Legacy/Segwit, X-only keys (64 chars) → Taproot.
                        </p>
                    </div>
                    <div class="tip-item">
                        <strong style="color: var(--text-color); font-size: 16px;">⬆️ Lift (Reverse Engineering):</strong>
                        <br>
                        <p style="margin: 4px 0 0 0; color: var(--text-color); font-size: 13px;">
                            Paste Bitcoin Script hex/ASM into the "Script HEX" or "Script ASM" fields to automatically lift them back to miniscript. Every lift also shows the policy equivalent. You can also lift miniscript expression to policy.
                        </p>
                    </div>
                    <div class="tip-item">
                        <strong style="color: var(--text-color); font-size: 16px;">🌐 Network Support:</strong>
                        <br>
                        <p style="margin: 4px 0 0 0; color: var(--text-color); font-size: 13px;">
                            Use the 🌐 button to toggle between mainnet and testnet address generation. Testnet keys (tpub) automatically generate testnet addresses, mainnet keys (xpub) generate mainnet addresses.
                        </p>
                    </div>
                    <div class="tip-item">
                        <strong style="color: var(--text-color); font-size: 16px;">📋 Local storage:</strong>
                        <br>
                        <p style="margin: 4px 0 0 0; color: var(--text-color); font-size: 13px;">
                            All data (keys, saved expressions) persists locally in your browser. No server - everything stays private. Use public keys only!
                        </p>
                    </div>
                    <div class="tip-item">
                        <strong style="color: var(--text-color); font-size: 16px;">🔗 Share your work:</strong>
                        <br>
                        <p style="margin: 4px 0 0 0; color: var(--text-color); font-size: 13px;">
                            Use the 🔗 button above any expression to generate a shareable URL. Three formats are available in Settings:<br>
                            • <strong>URL encoded:</strong> Shortest URLs, expression only. Not all platforms show a valid link<br>
                            • <strong>Base64:</strong> Compact encoding, expression only. Good for platforms like Twitter<br>
                            • <strong>JSON with custom keys:</strong> Includes your custom variables for sharing complete policies
                        </p>
                    </div>
                    <div class="tip-item">
                        <strong style="color: var(--text-color); font-size: 16px;">🏃 Auto compile examples:</strong>
                        <br>
                        <p style="margin: 4px 0 0 0; color: var(--text-color); font-size: 13px;">
                            When loading an example or a saved expression, it can be automatically compiled to show results immediately. This behavior can be toggled on/off in the Settings section below. When off, expressions load but wait for manual compilation.
                        </p>
                    </div>
                    <div class="tip-item">
                        <strong style="color: var(--text-color); font-size: 16px;">📊 Spending analysis:</strong>
                        <br>
                        <p style="margin: 4px 0 0 0; color: var(--text-color); font-size: 13px;">
                            View detailed cost analysis, satisfaction paths, and weight units for fee estimation in the compilation results.
                        </p>
                    </div>
                    <div class="tip-item">
                        <strong style="color: var(--text-color); font-size: 16px;">🏷️ HD wallet descriptors:</strong>
                        <br>
                        <p style="margin: 4px 0 0 0; color: var(--text-color); font-size: 13px;">
                            Full support for xpub/tpub with wildcards (/*). Index field appears automatically for derivation paths.
                        </p>
                    </div>
                    <div class="tip-item">
                        <strong style="color: var(--text-color); font-size: 16px;">🌳 Taproot branches:</strong>
                        <br>
                        <p style="margin: 4px 0 0 0; color: var(--text-color); font-size: 13px;">
                            For Policies with Taproot OR conditions, use the branch selector to choose which path to compile and compare costs.
                        </p>
                    </div>
                </div>
            </div>
        </details>

        <details style="margin-bottom: 20px;">
            <summary style="cursor: pointer; font-weight: 600; color: var(--text-secondary); margin-bottom: 10px; font-size: 16px;">⚙️ Settings</summary>
            <div style="background: var(--info-bg); padding: 20px; border-radius: 8px; margin-top: 10px; border: 1px solid var(--border-color);">
                <div style="display: grid; gap: 15px;">
                    <div class="setting-item" style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 1px solid var(--border-color);">
                        <div>
                            <strong style="color: var(--text-color); font-size: 16px;">🎨 Theme:</strong>
                            <br>
                            <p style="margin: 4px 0 0 0; color: var(--text-color); font-size: 13px;">
                                Choose between dark and light theme. Overrides system preference.
                            </p>
                        </div>
                        <button id="theme-selector" class="theme-toggle" style="margin-left: 20px; position: relative; top: auto; right: auto;" title="Toggle theme" aria-label="Toggle theme">
                            <span id="settings-theme-icon">☀️</span>
                        </button>
                    </div>
                    <div class="setting-item" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: var(--text-color); font-size: 16px;">🏃 Auto compile examples:</strong>
                            <br>
                            <p style="margin: 4px 0 0 0; color: var(--text-color); font-size: 13px;">
                                Automatically compile policies and miniscripts when loading from examples or saved expressions. When disabled, expressions load but require manual compilation.
                            </p>
                        </div>
                        <label class="toggle-switch" style="margin-left: 20px;" title="Toggle auto-compilation when loading examples or saved expressions">
                            <input type="checkbox" id="auto-compile-setting">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: var(--text-color); font-size: 16px;">📖 Show descriptions:</strong>
                            <br>
                            <p style="margin: 4px 0 0 0; color: var(--text-color); font-size: 13px;">
                                Display helpful descriptions when clicking example buttons. Turn off if you're a miniscript master who doesn't like explanations. 🧙‍♂️
                            </p>
                        </div>
                        <label class="toggle-switch" style="margin-left: 20px;">
                            <input type="checkbox" id="show-descriptions-setting" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: var(--text-color); font-size: 16px;">💡 Show editor tips:</strong>
                            <br>
                            <p style="margin: 4px 0 0 0; color: var(--text-color); font-size: 13px;">
                                Show helpful tips and instructions in empty editors. Turn off for a cleaner interface with just "Enter your policy/miniscript here..." instead of detailed guidance.
                            </p>
                        </div>
                        <label class="toggle-switch" style="margin-left: 20px;">
                            <input type="checkbox" id="simple-placeholders-setting" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: var(--text-color); font-size: 16px;">🔗 Share format:</strong>
                            <br>
                            <p style="margin: 4px 0 0 0; color: var(--text-color); font-size: 13px;">
                                Choose how shared URLs are formatted:<br>
                                • <strong>URL encoded:</strong> Shortest URLs, expression only without custom variables. Easy to read but not all platforms show a valid link.<br>
                                • <strong>Base64:</strong> Compact base64 encoding of expression only, without custom variables. Good for platforms that don't handle the url encoding well (Twitter).<br>
                                • <strong>JSON with custom keys:</strong> Base64-encoded JSON that includes your custom variables. Good for sharing new policies with new variables.<br>
                            </p>
                        </div>
                        <select id="share-format-setting" style="margin-left: 20px; padding: 6px 12px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color); font-size: 13px;">
                            <option value="url" selected>URL encoded</option>
                            <option value="json">JSON with custom keys</option>
                            <option value="base64">Base64 (expression only)</option>
                        </select>
                    </div>
                    <div class="setting-item" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: var(--text-color); font-size: 16px;">👁️ Hide corner buttons (web only):</strong>
                            <br>
                            <p style="margin: 4px 0 0 0; color: var(--text-color); font-size: 13px;">
                                Hide the GitHub and beer donation buttons in the top corners for a cleaner interface. Corner buttons are automatically hidden on mobile devices.
                            </p>
                        </div>
                        <label class="toggle-switch" style="margin-left: 20px;">
                            <input type="checkbox" id="hide-corner-buttons-setting">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: var(--text-color); font-size: 16px;">🌳 Tree structure display:</strong>
                            <br>
                            <p style="margin: 4px 0 0 0; color: var(--text-color); font-size: 13px;">
                                Choose how to display the tree structure in compilation results. Script Compilation shows opcodes and detailed structure, Visual Hierarchy shows a clean graphical tree, or hide it completely.
                            </p>
                        </div>
                        <select id="tree-display-setting" style="margin-left: 20px; padding: 6px 12px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color); font-size: 13px;">
                            <option value="script-compilation">Script Compilation</option>
                            <option value="visual-hierarchy" id="visual-hierarchy-option">Visual Hierarchy</option>
                            <option value="hidden">Hidden</option>
                        </select>
                    </div>
                </div>
            </div>
        </details>

        <!-- Mobile-only icons section -->
        <div class="mobile-icons" style="display: none; height: 20px; align-items: center; justify-content: center; margin-top: 5px; border-top: 1px solid var(--border-color);">
            <div style="margin-top: 7px;">
                <a href="https://github.com/adyshimony/miniscript-compiler" target="_blank" style="display: inline-block; margin: 0 6px; padding: 2px 6px; background: var(--container-bg); border: none; border-radius: 3px; color: var(--text-color); text-decoration: none; font-size: 13px; line-height: 1; transition: all 0.2s;" title="View source on GitHub">
                    🐙 View source
                </a>
                <a href="https://coinos.io/adys/receive" target="_blank" style="display: inline-block; margin: 0 6px; padding: 2px 6px; background: var(--container-bg); border: none; border-radius: 3px; color: var(--text-color); text-decoration: none; font-size: 13px; line-height: 1; transition: all 0.2s;" title="Buy me a beer 🍺">
                    🍺 Buy me a beer
                </a>
            </div>
        </div>
        
        </div>
        
    </div>
    
    <div id="save-modal" class="modal">
        <div class="modal-content">
            <h3>Save expression</h3>
            <label for="save-name">Expression name:</label>
            <input type="text" id="save-name" placeholder="Enter a name for this expression">
            <div class="button-group" style="margin-top: 20px;">
                <button id="confirm-save" class="primary-btn">Save</button>
                <button id="cancel-save" class="secondary-btn">Cancel</button>
            </div>
        </div>
    </div>

    <div id="save-policy-modal" class="modal">
        <div class="modal-content">
            <h3>Save policy</h3>
            <label for="save-policy-name">Policy name:</label>
            <input type="text" id="save-policy-name" placeholder="Enter a name for this policy">
            <div class="button-group" style="margin-top: 20px;">
                <button id="confirm-save-policy" class="primary-btn">Save</button>
                <button id="cancel-save-policy" class="secondary-btn">Cancel</button>
            </div>
        </div>
    </div>
    
    <div id="extract-keys-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h3>🔑 Extract Keys from Expression</h3>
            <p style="color: var(--text-secondary); margin-bottom: 10px;">Found keys in your expression. Select which ones to extract:</p>
            <div id="extract-error-message" style="display: none; background: var(--error-bg); border: 1px solid var(--error-border); color: var(--error-text); padding: 10px; border-radius: 4px; margin-bottom: 10px; font-size: 14px;"></div>
            <div class="button-group" style="margin-bottom: 10px; justify-content: flex-start;">
                <button id="select-all-keys" class="secondary-btn" style="font-size: 13px; padding: 4px 10px;">Select All</button>
                <button id="deselect-all-keys" class="secondary-btn" style="font-size: 13px; padding: 4px 10px;">Deselect All</button>
            </div>
            <div id="extract-keys-list" style="max-height: 400px; overflow-y: auto;">
                <!-- Key extraction items will be added here dynamically -->
            </div>
            <div class="button-group" style="margin-top: 20px;">
                <button id="confirm-extract" class="primary-btn">Extract Selected</button>
                <button id="cancel-extract" class="secondary-btn">Cancel</button>
            </div>
        </div>
    </div>
    
    <script type="module" src="/miniscript/script.js"></script>
    <script>
        // Global functions that need to be available immediately
        window.showPolicyDescription = function(exampleId) {
            // Check if descriptions are enabled
            const showDescriptions = localStorage.getItem('showDescriptions') !== 'false';
            if (!showDescriptions) {
                return;
            }
            
            const panel = document.getElementById('policy-description');
            const contentDiv = panel.querySelector('.description-content');
            
            const descriptions = {
                'single': {
                    title: '📄 Single Key Policy',
                    conditions: '🔓 Alice: Immediate spending (no restrictions)',
                    useCase: 'Personal wallet with single owner. Simple and efficient for individual use.',
                    security: '⚠️ Single point of failure - if Alice loses her key, funds are lost'
                },
                'or': {
                    title: '📄 OR Keys Policy',
                    conditions: '🔓 Alice: Can spend immediately\n🔓 Bob: Can spend immediately',
                    useCase: 'Shared wallet where either party can spend. Useful for joint accounts or backup access.',
                    security: '💡 Either key compromise results in fund loss'
                },
                'and': {
                    title: '📄 AND Keys Policy',
                    conditions: '🔓 Alice + Bob: Both signatures required',
                    useCase: '2-of-2 multisig. Both parties must agree to spend. Common for business partnerships.',
                    security: '💡 More secure but requires cooperation of both parties'
                },
                'threshold': {
                    title: '📄 2-of-3 Threshold Policy',
                    conditions: '🔓 Any 2 of: Alice, Bob, Charlie',
                    useCase: 'Board of directors or family trust. Prevents single point of failure while requiring majority.',
                    security: '💡 Balanced security - survives 1 key loss, prevents 1 key compromise'
                },
                'timelock': {
                    title: '📄 Timelock Policy',
                    conditions: '🔓 Alice: Immediate spending\n⏰ Bob: After 144 blocks (~1 day)',
                    useCase: 'Emergency access with delay. Alice has daily control, Bob can recover after waiting period.',
                    security: '💡 Cooling-off period prevents rushed decisions'
                },
                'xonly': {
                    title: '📄 Taproot X-only Key',
                    conditions: '🔓 David: Immediate spending (Taproot context)',
                    useCase: 'Demonstrates Taproot X-only public keys (64 characters). More efficient and private.',
                    security: '💡 Taproot provides better privacy and efficiency'
                },
                'corporate': {
                    title: '📄 Corporate Wallet Policy',
                    conditions: '🔓 Any 2 of: Alice, Bob, Charlie (board)\n⏰ Eva (CEO): After January 1, 2025',
                    useCase: 'Corporate treasury with board oversight and emergency CEO access after specific date.',
                    security: '💡 Board control with time-delayed executive override'
                },
                'recovery': {
                    title: '📄 Emergency Recovery Policy',
                    conditions: '🔓 Alice: Immediate spending (95% probability weight)\n⏰ Bob + Charlie + Eva: 2-of-3 after 1008 blocks (~1 week)',
                    useCase: 'Personal wallet with family emergency recovery. Alice has daily control. If Alice is unavailable, any 2 of her trusted contacts (family/friends) can recover funds after 1 week delay. The 95@ weight tells the compiler Alice path is used 95% of the time.',
                    security: '💡 Probability weight helps wallets optimize fees and witness sizes for common usage'
                },
                'twofa': {
                    title: '📄 2FA + Backup Policy',
                    conditions: '🔓 Alice + (Bob + secret OR wait 1 year)',
                    useCase: 'Two-factor authentication wallet. Alice + second device, or Alice alone after 1 year backup delay.',
                    security: '💡 Strong 2FA security with long-term recovery option'
                },
                'inheritance': {
                    title: '📄 Taproot Inheritance Policy',
                    conditions: '🔓 David: Immediate spending\n⏰ Helen + Ivan + Julia: 2-of-3 after 26280 blocks (~6 months)',
                    useCase: 'Estate planning. David controls funds, beneficiaries can inherit after extended waiting period.',
                    security: '💡 Long delay ensures David has opportunity to intervene'
                },
                'delayed': {
                    title: '📄 Taproot 2-of-2 OR Delayed',
                    conditions: '🔓 Julia + Karl: Immediate 2-of-2 spending\n⏰ David: After 144 blocks (~1 day)',
                    useCase: 'Joint account with single-party emergency access. Both parties agree, or one party after delay.',
                    security: '💡 Cooperative control with individual fallback'
                },
                'testnet_xpub': {
                    title: '📄 Testnet Extended Public Key',
                    conditions: '🔓 TestnetKey: Immediate spending (testnet context)',
                    useCase: 'Demonstrates testnet xpub usage for development and testing. Shows HD wallet integration with Bitcoin testnet.',
                    security: '💡 Always use testnet for development - never mainnet keys in testing'
                },
                'hodl': {
                    title: '📄 HODL Wallet Policy',
                    conditions: '🔓 Alice: Immediate spending (9x probability weight)\n⏰ Bob + Charlie + Eva + Frank: 3-of-4 after 1 year',
                    useCase: 'Long-term savings wallet. Alice has normal access, but requires family consensus after 1 year if Alice is unavailable.',
                    security: '💡 Designed to discourage frequent spending while providing family recovery'
                },
                'timelocked_thresh': {
                    title: '📄 Timelocked Multisig Policy',
                    conditions: '⏰ Any 2 of: Alice, Bob, Charlie (but only after January 1, 2025)',
                    useCase: 'Delayed activation multisig. Perfect for scheduled fund releases, vesting schedules, or planned distributions.',
                    security: '💡 Prevents any spending before the specified date, even with valid signatures'
                }
            };
            
            const desc = descriptions[exampleId];
            if (desc) {
                contentDiv.innerHTML = `
                    <h5 style="margin: 0 0 12px 0; color: var(--accent-color); font-size: 14px;">${desc.title}</h5>
                    <div style="margin-bottom: 10px;">
                        <strong style="color: var(--text-color); font-size: 13px;">Spending Conditions:</strong>
                        <div style="margin-top: 4px; font-size: 13px; color: var(--secondary-text); white-space: pre-line;">${desc.conditions}</div>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong style="color: var(--text-color); font-size: 13px;">Use Case:</strong>
                        <div style="margin-top: 4px; font-size: 13px; color: var(--secondary-text); line-height: 1.4;">${desc.useCase}</div>
                    </div>
                    <div>
                        <strong style="color: var(--text-color); font-size: 13px;">Security Notes:</strong>
                        <div style="margin-top: 4px; font-size: 13px; color: var(--secondary-text); line-height: 1.4;">${desc.security}</div>
                    </div>
                `;
                panel.style.display = 'block';
            }
        };

        window.showMiniscriptDescription = function(exampleId) {
            // Check if descriptions are enabled
            const showDescriptions = localStorage.getItem('showDescriptions') !== 'false';
            if (!showDescriptions) {
                return;
            }
            
            const panel = document.getElementById('miniscript-description');
            const contentDiv = panel.querySelector('.description-content');
            
            const descriptions = {
                'single': {
                    title: '⚙️ Single Key Miniscript',
                    structure: 'pk(Alice) → Direct public key check',
                    bitcoinScript: 'Compiles to: <Alice> CHECKSIG',
                    useCase: 'Simplest miniscript - requires a signature from Alice to spend.',
                    technical: '💡 Most efficient single-key pattern'
                },
                'and': {
                    title: '⚙️ 2-of-2 AND Miniscript',
                    structure: 'and_v(v:pk(Alice),pk(Bob)) → Verify Alice, then check Bob',
                    bitcoinScript: 'Compiles to: <Alice> CHECKSIGVERIFY <Bob> CHECKSIG',
                    useCase: 'Both Alice and Bob must provide signatures. Common for joint accounts or business partnerships.',
                    technical: '💡 Uses VERIFY wrapper for efficient sequential checking'
                },
                'or': {
                    title: '⚙️ OR Keys Miniscript',
                    structure: 'or_b(pk(Alice),s:pk(Bob)) → Boolean OR with stack swap',
                    bitcoinScript: 'Compiles to: <Alice> CHECKSIG SWAP <Bob> CHECKSIG BOOLOR',
                    useCase: 'Either Alice or Bob can spend. Useful for backup access or shared control.',
                    technical: '💡 s: wrapper swaps stack elements for proper evaluation'
                },
                'complex': {
                    title: '⚙️ AND/OR: Why and_v + or_b + Wrappers',
                    structure: 'and_v(v:pk(Alice),or_b(pk(Bob),s:pk(Charlie))) → Alice AND (Bob OR Charlie)',
                    bitcoinScript: '<Alice> CHECKSIGVERIFY <Bob> CHECKSIG SWAP <Charlie> CHECKSIG BOOLOR',
                    useCase: 'Alice must always sign, plus either Bob or Charlie. Demonstrates wrapper logic: v: for VERIFY, s: for stack SWAP.',
                    technical: '💡 Why these choices? and_v = Alice must be verified first (fail fast). or_b = boolean OR needed for final result. v:pk(Alice) = convert signature to VERIFY (stack efficient). s:pk(Charlie) = SWAP for proper stack order in BOOLOR.'
                },
                'timelock': {
                    title: '⚙️ Timelock: Why Double and_v Structure',
                    structure: 'and_v(v:pk(Alice),and_v(v:older(144),pk(Bob))) → Alice AND (144 blocks AND Bob)',
                    bitcoinScript: '<Alice> CHECKSIGVERIFY 144 CHECKSEQUENCEVERIFY <Bob> CHECKSIG',
                    useCase: 'Alice must sign, plus Bob can only sign after 144 blocks (~1 day). Why this structure? Prevents rushed joint decisions.',
                    technical: '💡 Double and_v structure: 1) Alice verified first (early failure if missing), 2) Timelock verified before Bob (no signature check if too early), 3) Bob\'s signature checked last. This ordering minimizes wasted computation when conditions aren\'t met.'
                },
                'xonly': {
                    title: '⚙️ Taproot X-only Key',
                    structure: 'pk(David) → X-only public key (64 chars)',
                    bitcoinScript: 'Compiles to Taproot-compatible script using 32-byte keys',
                    useCase: 'Demonstrates Taproot X-only public keys for improved efficiency and privacy.',
                    technical: '💡 Taproot uses Schnorr signatures with X-only keys'
                },
                'multisig': {
                    title: '⚙️ 1-of-3 Multisig Using or_d',
                    structure: 'or_d(pk(Alice),or_d(pk(Bob),pk(Charlie))) → Nested OR with DUP-IF pattern',
                    bitcoinScript: 'DUP IF <Alice> CHECKSIG ELSE DUP IF <Bob> CHECKSIG ELSE <Charlie> CHECKSIG ENDIF ENDIF',
                    useCase: 'Any of three parties can spend. Why or_d? Because we want the first successful signature to consume the condition, not evaluate all possibilities.',
                    technical: '💡 or_d chosen over or_i/or_b because: 1) More efficient for multiple options (early exit), 2) DUP-IF pattern is cheaper than boolean operations for N>2 cases, 3) Left branch "consumes" the condition when satisfied'
                },
                'recovery': {
                    title: '⚙️ Recovery Wallet Using or_d Logic',
                    structure: 'or_d(pk(Alice),and_v(v:pk(Bob),older(1008))) → Alice OR (Bob + 1008 blocks)',
                    bitcoinScript: 'DUP IF <Alice> CHECKSIG ELSE <Bob> CHECKSIGVERIFY 1008 CHECKSEQUENCEVERIFY ENDIF',
                    useCase: 'Alice has daily control, Bob can recover after ~1 week. Why or_d? Because Alice\'s signature should immediately satisfy the condition without evaluating Bob\'s timelock.',
                    technical: '💡 or_d logic: Alice\'s path "consumes" the script (early exit), Bob\'s path only evaluated if Alice fails. This prevents unnecessary timelock evaluation when Alice spends normally. and_v ensures Bob AND timelock both verified.'
                },
                'hash': {
                    title: '⚙️ Hash + Timelock Miniscript',
                    structure: 'and_v(v:pk(Alice),or_d(pk(Bob),and_v(v:hash160(...),older(144))))',
                    bitcoinScript: 'Alice AND (Bob OR (secret + timelock))',
                    useCase: 'Alice + Bob normally, or Alice + secret after delay. Two-factor authentication pattern.',
                    technical: '💡 hash160 requires RIPEMD160(SHA256(preimage))'
                },
                'inheritance': {
                    title: '⚙️ Taproot Inheritance Miniscript',
                    structure: 'and_v(v:pk(David),or_d(pk(Helen),and_v(v:pk(Ivan),older(52560))))',
                    bitcoinScript: 'David AND (Helen OR (Ivan + 1 year))',
                    useCase: 'David controls funds, Helen can inherit immediately, or Ivan after extended delay.',
                    technical: '💡 Long timelock (52560 blocks ≈ 1 year) for inheritance planning'
                },
                'delayed': {
                    title: '⚙️ Taproot Immediate OR Delayed',
                    structure: 'or_d(pk(Julia),and_v(v:pk(Karl),older(144))) → Julia OR (Karl + delay)',
                    bitcoinScript: 'Julia immediate OR Karl after 144 blocks',
                    useCase: 'Julia can spend immediately, Karl can spend after 1-day cooling period.',
                    technical: '💡 Demonstrates Taproot miniscript with short timelock'
                },
                'pkh': {
                    title: '⚙️ Pay-to-pubkey-hash',
                    structure: 'pkh(Alice) → Hash-based key reference',
                    bitcoinScript: 'Compiles to: DUP HASH160 <Alice_hash> EQUALVERIFY CHECKSIG',
                    useCase: 'Similar to P2PKH addresses. More private as public key is hidden until spending.',
                    technical: '💡 Classic Bitcoin pattern - reveals pubkey only when spending'
                },
                'wrap': {
                    title: '⚙️ Wrapped Key Fragment',
                    structure: 'c:pk_k(Alice) → Check-wrapper around key fragment',
                    bitcoinScript: 'Compiles with CHECKSIG wrapper for type correctness',
                    useCase: 'Demonstrates miniscript wrapper system for fragment composition.',
                    technical: '💡 c: wrapper converts signature to boolean, pk_k pushes key'
                },
                'or_i': {
                    title: '⚙️ OR with If-Else (or_i vs or_d vs or_b)',
                    structure: 'or_i(pk(Alice),pk(Bob)) → IF Alice ELSE Bob ENDIF',
                    bitcoinScript: 'IF <Alice> CHECKSIG ELSE <Bob> CHECKSIG ENDIF',
                    useCase: 'Either Alice or Bob can spend. Why or_i? When you want conditional execution where the spender chooses which branch to execute upfront.',
                    technical: '💡 or_i vs others: or_i = spender picks branch (IF/ELSE), or_d = left branch consumes (DUP-IF), or_b = evaluate both then OR (boolean logic). or_i most efficient for simple 2-way choices.'
                },
                'after': {
                    title: '⚙️ Absolute Timelock',
                    structure: 'and_v(v:pk(Alice),after(1767225600)) → Alice + absolute time',
                    bitcoinScript: 'Verifies Alice signature and checks absolute timestamp',
                    useCase: 'Alice can only spend after specific date (Jan 1, 2025). Useful for scheduled payments.',
                    technical: '💡 Uses CLTV (CheckLockTimeVerify) for absolute time constraints'
                },
                'htlc_time': {
                    title: '⚙️ Time-based HTLC: or_d for Efficient Cooperation',
                    structure: 'and_v(v:pk(Alice),or_d(pk(Bob),and_v(v:hash160(...),older(144))))',
                    bitcoinScript: '<Alice> CHECKSIGVERIFY DUP IF <Bob> CHECKSIG ELSE <hash> HASH160 EQUALVERIFY 144 CHECKSEQUENCEVERIFY ENDIF',
                    useCase: 'Alice + Bob for normal cooperation, or Alice + hash secret after delay if Bob disappears. Why or_d? Bob\'s cooperation path should exit immediately without evaluating timelock.',
                    technical: '💡 HTLC efficiency: or_d means happy case (Alice+Bob) never touches the hash or timelock logic. Only when Bob fails to cooperate does the script evaluate the hash160 and older conditions. This saves gas/fees in the common cooperative case.'
                },
                'htlc_hash': {
                    title: '⚙️ Hash-based HTLC: or_d for Different Logic',
                    structure: 'or_d(pk(Alice),and_v(v:hash160(...),and_v(v:pk(Bob),older(144))))',
                    bitcoinScript: 'DUP IF <Alice> CHECKSIG ELSE <hash> HASH160 EQUALVERIFY <Bob> CHECKSIGVERIFY 144 CHECKSEQUENCEVERIFY ENDIF',
                    useCase: 'Alice can claim immediately (refund), or Bob claims with hash preimage after delay. Why or_d? Alice\'s refund shouldn\'t require evaluating Bob\'s complex conditions.',
                    technical: '💡 Different HTLC pattern: Alice gets immediate refund path (common in failed payments), Bob must prove hash knowledge AND wait. or_d ensures Alice\'s refund is simple and efficient, while Bob\'s claim requires all three conditions (hash + signature + time).'
                },
                'full_descriptor': {
                    title: '⚙️ Full HD Wallet Descriptor',
                    structure: 'pk(MainnetKey) → Complete extended public key with derivation',
                    bitcoinScript: 'Uses mainnet xpub with full derivation path and fingerprint',
                    useCase: 'Production wallet integration showing complete HD wallet descriptor format with derivation paths.',
                    technical: '💡 Demonstrates xpub format: [fingerprint/path]xpub.../derivation'
                },
                'range_descriptor': {
                    title: '⚙️ Multipath Range Descriptor',
                    structure: 'pk(RangeKey) → HD key with multipath range <1;0>/*',
                    bitcoinScript: 'Uses ranged derivation for multiple address generation',
                    useCase: 'Advanced HD wallet pattern for generating ranges of addresses from single descriptor. Used in wallet software.',
                    technical: '💡 <1;0>/* creates two derivation paths: /1/* and /0/* for change and receive addresses'
                },
                'vault_complex': {
                    title: '⚙️ Complex Multi-tier Vault System',
                    structure: 'Nested or_i structure with multiple timelock tiers and threshold conditions',
                    bitcoinScript: 'Highly complex conditional execution with multiple spending paths and delays',
                    useCase: 'Advanced vault system with multiple security tiers and time delays. Shows miniscript power for complex custody solutions.',
                    technical: '💡 Demonstrates deep nesting capabilities and multiple conditional spending paths'
                }
            };
            
            const desc = descriptions[exampleId];
            if (desc) {
                contentDiv.innerHTML = `
                    <h5 style="margin: 0 0 12px 0; color: var(--accent-color); font-size: 14px;">${desc.title}</h5>
                    <div style="margin-bottom: 10px;">
                        <strong style="color: var(--text-color); font-size: 13px;">Structure:</strong>
                        <div style="margin-top: 4px; font-size: 13px; color: var(--secondary-text); line-height: 1.4; font-family: monospace; background: var(--hover-bg); padding: 6px; border-radius: 4px;">${desc.structure}</div>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong style="color: var(--text-color); font-size: 13px;">Bitcoin Script:</strong>
                        <div style="margin-top: 4px; font-size: 13px; color: var(--secondary-text); line-height: 1.4;">${desc.bitcoinScript}</div>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong style="color: var(--text-color); font-size: 13px;">Use Case:</strong>
                        <div style="margin-top: 4px; font-size: 13px; color: var(--secondary-text); line-height: 1.4;">${desc.useCase}</div>
                    </div>
                    <div>
                        <strong style="color: var(--text-color); font-size: 13px;">Technical Notes:</strong>
                        <div style="margin-top: 4px; font-size: 13px; color: var(--secondary-text); line-height: 1.4;">${desc.technical}</div>
                    </div>
                `;
                panel.style.display = 'block';
            }
        };

        // Note: window.loadExample and window.loadPolicyExample are defined in
        // /miniscript/modules/window-functions.js (loaded via script.js module import)

        // Theme switching functionality
        function initTheme() {
            const themeSelector = document.getElementById('theme-selector');
            const floatingToggle = document.getElementById('floating-theme-toggle');
            const themeIcon = document.getElementById('theme-icon');
            const settingsThemeIcon = document.getElementById('settings-theme-icon');
            const savedTheme = localStorage.getItem('theme') || 'dark';
            
            // Apply saved theme
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            // Update both theme button icons (show what you can switch TO)
            const iconToShow = savedTheme === 'dark' ? '☀️' : '🌙';
            if (themeIcon) {
                themeIcon.textContent = iconToShow;
            }
            if (settingsThemeIcon) {
                settingsThemeIcon.textContent = iconToShow;
            }
            
            // Force apply styling for all editable elements after theme is set
            setTimeout(() => {
                if (window.compiler && window.compiler.enforceElementStyling) {
                    const policyInput = document.getElementById('policy-input');
                    const expressionInput = document.getElementById('expression-input');
                    const scriptHex = document.getElementById('script-hex-display');
                    const scriptAsm = document.getElementById('script-asm-display');
                    const addressDisplay = document.getElementById('address-display');
                    if (policyInput) window.compiler.enforceElementStyling(policyInput);
                    if (expressionInput) window.compiler.enforceElementStyling(expressionInput);
                    if (scriptHex) window.compiler.enforceElementStyling(scriptHex);
                    if (scriptAsm) window.compiler.enforceElementStyling(scriptAsm);
                    if (addressDisplay) window.compiler.enforceElementStyling(addressDisplay);
                }
            }, 100);
            
            // Listen for theme changes from settings button
            if (themeSelector) {
                themeSelector.addEventListener('click', function() {
                    const currentTheme = document.documentElement.getAttribute('data-theme');
                    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                    
                    // Update theme
                    document.documentElement.setAttribute('data-theme', newTheme);
                    localStorage.setItem('theme', newTheme);
                    
                    // Update both button icons (show what you can switch TO)
                    const iconToShow = newTheme === 'dark' ? '☀️' : '🌙';
                    const themeIcon = document.getElementById('theme-icon');
                    const settingsThemeIcon = document.getElementById('settings-theme-icon');
                    if (themeIcon) {
                        themeIcon.textContent = iconToShow;
                    }
                    if (settingsThemeIcon) {
                        settingsThemeIcon.textContent = iconToShow;
                    }
                    
                    if (window.compiler) {
                        const policyInput = document.getElementById('policy-input');
                        const expressionInput = document.getElementById('expression-input');
                        const scriptHex = document.getElementById('script-hex-display');
                        const scriptAsm = document.getElementById('script-asm-display');
                        const addressDisplay = document.getElementById('address-display');
                        
                        if (newTheme === 'light' && window.compiler.enforceElementStyling) {
                            // Apply light theme styling
                            setTimeout(() => {
                                if (policyInput) window.compiler.enforceElementStyling(policyInput);
                                if (expressionInput) window.compiler.enforceElementStyling(expressionInput);
                                if (scriptHex) window.compiler.enforceElementStyling(scriptHex);
                                if (scriptAsm) window.compiler.enforceElementStyling(scriptAsm);
                                if (addressDisplay) window.compiler.enforceElementStyling(addressDisplay);
                            }, 50);
                        } else if (newTheme === 'dark') {
                            // Clear forced styles to let CSS take over
                            [policyInput, expressionInput, scriptHex, scriptAsm, addressDisplay].forEach(element => {
                                if (element) {
                                    element.style.removeProperty('border');
                                    element.style.removeProperty('background');
                                    element.style.removeProperty('filter');
                                    element.style.removeProperty('border-radius');
                                    element.style.removeProperty('padding');
                                    element.style.removeProperty('box-shadow');
                                }
                            });
                        }
                    }
                });
            }
            
            // Listen for floating toggle button clicks
            if (floatingToggle) {
                floatingToggle.addEventListener('click', function() {
                    const currentTheme = document.documentElement.getAttribute('data-theme');
                    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                    
                    // Update theme
                    document.documentElement.setAttribute('data-theme', newTheme);
                    localStorage.setItem('theme', newTheme);
                    
                    // Update both button icons (show what you can switch TO)
                    const iconToShow = newTheme === 'dark' ? '☀️' : '🌙';
                    if (themeIcon) {
                        themeIcon.textContent = iconToShow;
                    }
                    const settingsThemeIcon = document.getElementById('settings-theme-icon');
                    if (settingsThemeIcon) {
                        settingsThemeIcon.textContent = iconToShow;
                    }
                    
                    // Apply same theme change logic as settings selector
                    if (window.compiler) {
                        const policyInput = document.getElementById('policy-input');
                        const expressionInput = document.getElementById('expression-input');
                        const scriptHex = document.getElementById('script-hex-display');
                        const scriptAsm = document.getElementById('script-asm-display');
                        const addressDisplay = document.getElementById('address-display');
                        
                        if (newTheme === 'light' && window.compiler.enforceElementStyling) {
                            setTimeout(() => {
                                if (policyInput) window.compiler.enforceElementStyling(policyInput);
                                if (expressionInput) window.compiler.enforceElementStyling(expressionInput);
                                if (scriptHex) window.compiler.enforceElementStyling(scriptHex);
                                if (scriptAsm) window.compiler.enforceElementStyling(scriptAsm);
                                if (addressDisplay) window.compiler.enforceElementStyling(addressDisplay);
                            }, 50);
                        } else if (newTheme === 'dark') {
                            [policyInput, expressionInput, scriptHex, scriptAsm, addressDisplay].forEach(element => {
                                if (element) {
                                    element.style.removeProperty('border');
                                    element.style.removeProperty('background');
                                    element.style.removeProperty('filter');
                                    element.style.removeProperty('border-radius');
                                    element.style.removeProperty('padding');
                                    element.style.removeProperty('box-shadow');
                                }
                            });
                        }
                    }
                });
            }
        }
        
        // Initialize theme on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initTheme);
        } else {
            initTheme();
        }
        
        // Auto-compile checkbox synchronization
        document.addEventListener('DOMContentLoaded', function() {
            const autoCompileSetting = document.getElementById('auto-compile-setting');
            const autoCompilePolicy = document.getElementById('auto-compile-policy');
            const autoCompileMiniscript = document.getElementById('auto-compile-miniscript');
            
            // Initialize checkboxes with saved setting
            const savedAutoCompile = localStorage.getItem('autoCompile') === 'true';
            if (autoCompilePolicy) autoCompilePolicy.checked = savedAutoCompile;
            if (autoCompileMiniscript) autoCompileMiniscript.checked = savedAutoCompile;
            if (autoCompileSetting) autoCompileSetting.checked = savedAutoCompile;
            
            // Sync all checkboxes when any one changes
            function syncAutoCompile(checked) {
                localStorage.setItem('autoCompile', checked);
                if (autoCompileSetting) autoCompileSetting.checked = checked;
                if (autoCompilePolicy) autoCompilePolicy.checked = checked;
                if (autoCompileMiniscript) autoCompileMiniscript.checked = checked;
            }
            
            // Add event listeners
            if (autoCompilePolicy) {
                autoCompilePolicy.addEventListener('change', (e) => syncAutoCompile(e.target.checked));
            }
            if (autoCompileMiniscript) {
                autoCompileMiniscript.addEventListener('change', (e) => syncAutoCompile(e.target.checked));
            }
            if (autoCompileSetting) {
                autoCompileSetting.addEventListener('change', (e) => syncAutoCompile(e.target.checked));
            }
            
            // Show descriptions setting
            const showDescriptionsSetting = document.getElementById('show-descriptions-setting');
            // Default to true if not set, or if set to anything other than 'false'
            const savedShowDescriptions = localStorage.getItem('showDescriptions') !== 'false';
            if (showDescriptionsSetting) {
                showDescriptionsSetting.checked = savedShowDescriptions;
                showDescriptionsSetting.addEventListener('change', (e) => {
                    const newValue = String(e.target.checked);
                    localStorage.setItem('showDescriptions', newValue);
                    // Hide all description panels when turned off
                    if (!e.target.checked) {
                        const policyDesc = document.getElementById('policy-description');
                        const miniscriptDesc = document.getElementById('miniscript-description');
                        if (policyDesc) policyDesc.style.display = 'none';
                        if (miniscriptDesc) miniscriptDesc.style.display = 'none';
                    }
                });
            }
            
            // Show editor tips setting
            const simplePlaceholdersSetting = document.getElementById('simple-placeholders-setting');
            const savedShowTips = localStorage.getItem('showEditorTips');
            const defaultShowTips = savedShowTips !== null ? savedShowTips === 'true' : true; // Default to true (show tips)
            
            // Store the full and simple placeholder texts
            const placeholders = {
                policy: {
                    full: "Enter your Policy here or click an example below.\nUse 🏷️ to show/hide key names, 🔑 to generate keys from your new Policy.\nUpon Policy compile, Miniscript will be compiled automatically.\nYou can turn off these tips and example descriptions in setting.",
                    simple: "Enter your Policy here..."
                },
                miniscript: {
                    full: "Enter your Miniscript here or click an example below.\nUse 🏷️ to show/hide key names, 🔑 to generate keys from your new expression.\nUse ⬆️ to lift your expression back to policy.\nYou can turn off these tips and example descriptions in setting.",
                    simple: "Enter your Miniscript here..."
                }
            };
            
            // Function to update placeholders
            function updatePlaceholders(showTips) {
                const policyInput = document.getElementById('policy-input');
                const miniscriptInput = document.getElementById('expression-input');
                
                if (policyInput) {
                    policyInput.setAttribute('data-placeholder', showTips ? placeholders.policy.full : placeholders.policy.simple);
                }
                if (miniscriptInput) {
                    miniscriptInput.setAttribute('data-placeholder', showTips ? placeholders.miniscript.full : placeholders.miniscript.simple);
                }
            }
            
            if (simplePlaceholdersSetting) {
                simplePlaceholdersSetting.checked = defaultShowTips;
                
                simplePlaceholdersSetting.addEventListener('change', (e) => {
                    localStorage.setItem('showEditorTips', String(e.target.checked));
                    updatePlaceholders(e.target.checked);
                });
            }
            
            // Set initial placeholders on page load (single source of truth)
            updatePlaceholders(defaultShowTips);
            
            // Also hide descriptions on page load if setting is off
            if (!savedShowDescriptions) {
                const policyDesc = document.getElementById('policy-description');
                const miniscriptDesc = document.getElementById('miniscript-description');
                if (policyDesc) policyDesc.style.display = 'none';
                if (miniscriptDesc) miniscriptDesc.style.display = 'none';
            }
        });

    </script>


</body>
</html>